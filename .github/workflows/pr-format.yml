name: PR Format Check

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  pr-format:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR body format
        uses: actions/github-script@v7
        with:
          script: |
            const body = (context.payload.pull_request?.body || "").trim();
            if (!body) {
              core.setFailed("PR body is empty.");
              return;
            }

            const required = [
              "## Что изменилось",
              "## Почему это важно",
              "## Что стало возможным",
              "## Открытые вопросы"
            ];

            for (const heading of required) {
              if (!body.includes(heading)) {
                core.setFailed(`Missing required heading: ${heading}`);
                return;
              }
            }

            function hasBulletAfter(heading) {
              const idx = body.indexOf(heading);
              const next = body.indexOf("## ", idx + heading.length);
              const section = body.slice(idx + heading.length, next === -1 ? body.length : next);
              return section.split("\n").some((line) => line.trim().startsWith("- "));
            }

            for (const heading of required) {
              if (!hasBulletAfter(heading)) {
                core.setFailed(`Section "${heading}" must contain at least one bullet point.`);
                return;
              }
            }
