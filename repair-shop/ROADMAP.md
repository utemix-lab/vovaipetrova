# Карта преобразований

**Дата создания:** 12 февраля 2026

---

## Типизация записей

```
ДИАГНОЗ → ЭТАП → ВАРИАНТЫ [A, B, C...] → ВЫБРАН [X] → РЕЗУЛЬТАТ → РАЗВИЛКА → ВАРИАНТЫ [X1, X2, X3...] → ...
```

| Тип | Описание |
|-----|----------|
| `ДИАГНОЗ` | Описание проблемы |
| `ЭТАП` | Номер этапа в цепочке |
| `ВАРИАНТЫ` | Возможные пути решения |
| `ВЫБРАН` | Принятое решение |
| `РЕЗУЛЬТАТ` | Что получилось |
| `РАЗВИЛКА` | Точка ветвления для следующего этапа |

---

## ЭТАП 0: Корневой диагноз

**ДИАГНОЗ:** Отсутствие формального слоя инвариантов. Смешение 5 слоёв (онтология, состояние, логика, представление, инфраструктура). Подсветка — событие + состояние + эффект + правило + визуализация одновременно.

**См.:** `2026-02-12_DIAGNOSIS.md`

---

## ЭТАП 1: Выбор стратегии

**ВАРИАНТЫ:**

| ID | Название | Описание |
|----|----------|----------|
| A | Продолжать | Строить фичи, фиксировать течи |
| B | Полный рефакторинг | Разделить слои, переписать всё |
| C | INVARIANTS.md | Документ с инвариантами |
| D | TypeScript | Типизация как инварианты |
| E | OWNERSHIP_GRAPH | Граф ответственности |
| F | Гибридный | C + E + постепенная типизация |
| **G** | **Вычислительная модель** | **Чистые функции для онтологии** |

**ВЫБРАН:** G — Формализация вычислительной модели

**ОБОСНОВАНИЕ:** Проблема не в структуре файлов, а в степени формализации онтологии. Нужна формальная точка причинности, а не разделение по папкам.

**См.:** `DECISIONS.md` → Решение #1

---

## ЭТАП 2: Реализация G (highlightModel)

**РЕЗУЛЬТАТ:**
- Создан `render/src/ontology/highlightModel.js`
- `computeHighlight(context, graph) → HighlightState`
- Интеграция в `visitor.js` через `updateHighlight()`
- Build успешен, подсветка работает

**Commit:** `5f8f4e0`

---

## РАЗВИЛКА после ЭТАПА 2

**ТЕКУЩЕЕ СОСТОЯНИЕ:**
- Есть формальная точка причинности для подсветки
- `visitor.js` по-прежнему 4500+ строк
- Другие аспекты (navigation, scope, templates) не формализованы

**ВАРИАНТЫ:**

| ID | Название | Описание | Сложность | Риск |
|----|----------|----------|-----------|------|
| G.1 | Тесты для highlightModel | Unit-тесты для computeHighlight() | Низкая | Низкий |
| G.2 | TypeScript для highlightModel | Типизировать модель | Низкая | Низкий |
| G.3 | navigationModel.js | Чистая модель навигации | Средняя | Низкий |
| G.4 | scopeModel.js | Чистая модель scope | Средняя | Низкий |
| G.5 | templateModel.js | Чистая модель шаблонов страниц | Средняя | Средний |
| G.6 | OWL-экспорт | Экспорт модели в OWL-формат | Высокая | Средний |
| C | INVARIANTS.md | Вернуться к документации инвариантов | Низкая | Низкий |
| E | OWNERSHIP_GRAPH | Построить граф ответственности | Низкая | Низкий |

**ОЖИДАНИЕ:** Выбор следующего шага

---

## Граф решений (ASCII)

```
                    ┌─────────────────┐
                    │  ДИАГНОЗ (0)    │
                    │  Смешение слоёв │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │   ЭТАП 1        │
                    │   Выбор         │
                    │   стратегии     │
                    └────────┬────────┘
                             │
        ┌──────┬──────┬──────┼──────┬──────┬──────┐
        │      │      │      │      │      │      │
        A      B      C      D      E      F      G ◄── ВЫБРАН
        │      │      │      │      │      │      │
        ✗      ✗      ✗      ✗      ✗      ✗      ✓
                                                  │
                                         ┌────────▼────────┐
                                         │   ЭТАП 2        │
                                         │   highlightModel│
                                         │   ✓ ВЫПОЛНЕН    │
                                         └────────┬────────┘
                                                  │
                                         ┌────────▼────────┐
                                         │   РАЗВИЛКА      │
                                         │   после G       │
                                         └────────┬────────┘
                                                  │
        ┌──────┬──────┬──────┬──────┬──────┬──────┼──────┬──────┐
        │      │      │      │      │      │      │      │      │
       G.1    G.2    G.3    G.4    G.5    G.6     C      E      ?
      тесты  TS    navig  scope  templ  OWL   INVAR  OWNER   ...
        │      │      │      │      │      │      │      │
        ?      ?      ?      ?      ?      ?      ?      ?
```

---

## Метрики прогресса

| Метрика | До | После ЭТАПА 2 | Цель |
|---------|-----|---------------|------|
| Формализованные модели | 0 | 1 (highlight) | 5+ |
| Точки мутации подсветки | 5+ | 1 | 1 |
| Чистые функции онтологии | 0 | 1 | 10+ |
| Покрытие тестами моделей | 0% | 0% | 80%+ |
| TypeScript в моделях | 0% | 0% | 100% |

---

*Ожидание выбора следующего шага.*
