# Карта преобразований

**Дата создания:** 12 февраля 2026

---

## Типизация записей

```
ДИАГНОЗ → ЭТАП → ВАРИАНТЫ [A, B, C...] → ВЫБРАН [X] → РЕЗУЛЬТАТ → РАЗВИЛКА → ВАРИАНТЫ [X1, X2, X3...] → ...
```

| Тип | Описание |
|-----|----------|
| `ДИАГНОЗ` | Описание проблемы |
| `ЭТАП` | Номер этапа в цепочке |
| `ВАРИАНТЫ` | Возможные пути решения |
| `ВЫБРАН` | Принятое решение |
| `РЕЗУЛЬТАТ` | Что получилось |
| `РАЗВИЛКА` | Точка ветвления для следующего этапа |

---

## ЭТАП 0: Корневой диагноз

**ДИАГНОЗ:** Отсутствие формального слоя инвариантов. Смешение 5 слоёв (онтология, состояние, логика, представление, инфраструктура). Подсветка — событие + состояние + эффект + правило + визуализация одновременно.

**См.:** `2026-02-12_DIAGNOSIS.md`

---

## ЭТАП 1: Выбор стратегии

**ВАРИАНТЫ:**

| ID | Название | Описание |
|----|----------|----------|
| A | Продолжать | Строить фичи, фиксировать течи |
| B | Полный рефакторинг | Разделить слои, переписать всё |
| C | INVARIANTS.md | Документ с инвариантами |
| D | TypeScript | Типизация как инварианты |
| E | OWNERSHIP_GRAPH | Граф ответственности |
| F | Гибридный | C + E + постепенная типизация |
| **G** | **Вычислительная модель** | **Чистые функции для онтологии** |

**ВЫБРАН:** G — Формализация вычислительной модели

**ОБОСНОВАНИЕ:** Проблема не в структуре файлов, а в степени формализации онтологии. Нужна формальная точка причинности, а не разделение по папкам.

**См.:** `DECISIONS.md` → Решение #1

---

## ЭТАП 2: Реализация G (highlightModel)

**РЕЗУЛЬТАТ:**
- Создан `render/src/ontology/highlightModel.js`
- `computeHighlight(context, graph) → HighlightState`
- Интеграция в `visitor.js` через `updateHighlight()`
- Build успешен, подсветка работает

**Commit:** `5f8f4e0`

---

## РАЗВИЛКА после ЭТАПА 2

**ТЕКУЩЕЕ СОСТОЯНИЕ:**
- Есть формальная точка причинности для подсветки
- `visitor.js` по-прежнему 4500+ строк
- Другие аспекты (navigation, scope, templates) не формализованы

**ВАРИАНТЫ:**

| ID | Название | Описание | Сложность | Риск |
|----|----------|----------|-----------|------|
| G.1 | Тесты для highlightModel | Unit-тесты для computeHighlight() | Низкая | Низкий |
| G.2 | TypeScript для highlightModel | Типизировать модель | Низкая | Низкий |
| G.3 | navigationModel.js | Чистая модель навигации | Средняя | Низкий |
| G.4 | scopeModel.js | Чистая модель scope | Средняя | Низкий |
| G.5 | templateModel.js | Чистая модель шаблонов страниц | Средняя | Средний |
| G.6 | OWL-экспорт | Экспорт модели в OWL-формат | Высокая | Средний |
| C | INVARIANTS.md | Вернуться к документации инвариантов | Низкая | Низкий |
| E | OWNERSHIP_GRAPH | Построить граф ответственности | Низкая | Низкий |

**ОЖИДАНИЕ:** Выбор следующего шага

---

## Граф решений (ASCII)

```
                    ┌─────────────────┐
                    │  ДИАГНОЗ (0)    │
                    │  Смешение слоёв │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │   ЭТАП 1        │
                    │   Выбор         │
                    │   стратегии     │
                    └────────┬────────┘
                             │
        ┌──────┬──────┬──────┼──────┬──────┬──────┐
        │      │      │      │      │      │      │
        A      B      C      D      E      F      G ◄── ВЫБРАН
        │      │      │      │      │      │      │
        ✗      ✗      ✗      ✗      ✗      ✗      ✓
                                                  │
                                         ┌────────▼────────┐
                                         │   ЭТАП 2        │
                                         │   highlightModel│
                                         │   ✓ ВЫПОЛНЕН    │
                                         └────────┬────────┘
                                                  │
                                         ┌────────▼────────┐
                                         │   РАЗВИЛКА      │
                                         │   после G       │
                                         └────────┬────────┘
                                                  │
        ┌──────┬──────┬──────┬──────┬──────┬──────┼──────┬──────┐
        │      │      │      │      │      │      │      │      │
       G.1    G.2    G.3    G.4    G.5    G.6     C      E      ?
      тесты  TS    navig  scope  templ  OWL   INVAR  OWNER   ...
        │      │      │      │      │      │      │      │
        ?      ?      ?      ?      ?      ?      ?      ?
```

---

## Метрики прогресса

| Метрика | До | После ЭТАПА 2 | После Phase 2 | Цель |
|---------|-----|---------------|---------------|------|
| Формализованные модели | 0 | 1 (highlight) | 5+ | 10+ |
| Точки мутации подсветки | 5+ | 1 | 0 | 0 |
| Чистые функции онтологии | 0 | 1 | 5+ | 10+ |
| Покрытие тестами моделей | 0% | 0% | 50%+ | 80%+ |
| TypeScript в моделях | 0% | 0% | 100% | 100% |
| Проекции (линзы) | 1 | 1 | 2+ | 5+ |

---

## ЭТАП 3: Phase 2 — Core → Multi-Projection

**ВЫБРАН:** Phase 2 (продолжение G)

**ЦЕЛЬ:** Создать формальный Core, который можно рендерить в разные линзы без переписывания логики.

### Шаги Phase 2

| Шаг | Название | Описание | Статус |
|-----|----------|----------|--------|
| 2.0 | Зафиксировать цель | Документация в ROADMAP.md | ✓ |
| 2.1 | Завершить D | Проверить чистоту computeHighlight(), убрать мутации | ✓ |
| 2.2 | GraphModel.js | Абстрактная модель графа с API | ✓ |
| 2.3 | Правила в Core | highlight, scope, selection в Core | ✓ |
| 2.4 | Projection | Абстракция адаптера рендеринга | ✓ |
| 2.5 | DevProjection | Прототип dev-линзы | ✓ |
| 2.6 | OwnershipGraph | Граф владения состоянием | ✓ |
| 2.7 | Проверка на кристалл | Тест: новая линза без копирования логики | ✓ |

### Критерий завершения D

```
✓ computeHighlight() — чистая функция
✓ нет мутаций global state
✓ visitor только потребляет HighlightState
✓ highlightedNodes больше не источник истины
✓ Core можно вызвать вне браузера
```

### Архитектура Core

```
┌─────────────────────────────────────────────────────────────────┐
│                           CORE                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ GraphModel  │  │ Highlight   │  │ Scope       │              │
│  │             │  │ Model       │  │ Model       │              │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘              │
│         │                │                │                      │
│         └────────────────┼────────────────┘                      │
│                          │                                       │
│                   ┌──────▼──────┐                                │
│                   │ Ownership   │                                │
│                   │ Graph       │                                │
│                   └─────────────┘                                │
└─────────────────────────────────────────────────────────────────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
    ┌──────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐
    │ Visitor     │ │ Dev         │ │ Doc         │
    │ Projection  │ │ Projection  │ │ Projection  │
    │ (Three.js)  │ │ (2D/JSON)   │ │ (Markdown)  │
    └─────────────┘ └─────────────┘ └─────────────┘
```

### Будущие линзы

| Линза | Описание |
|-------|----------|
| **Visitor** | 3D-граф смысловых связей (текущий) |
| **Dev** | Граф вычислений, зависимостей, ownership, потоки состояния |
| **Doc** | Автогенерация документации, инварианты, спецификации |
| **Ontology** | Экспорт в OWL/RDF, GraphRAG-интеграция |
| **Debug** | Live-визуализация state transitions, дифф состояний |
| **Meta** | Граф эволюции архитектуры, анализ сложности |

### Главное правило

> Любая новая фича должна:
> 1. Добавляться в Core как правило или отношение
> 2. Автоматически становиться доступной всем проекциям
> 3. Не требовать логики в renderer
>
> **Если фича требует логики в renderer — она добавлена не туда.**

### Формула

```
Строим не второй режим.
Строим чистый Core + систему проекций.
```

---

## Граф решений (ASCII) — обновлённый

```
                    ┌─────────────────┐
                    │  ДИАГНОЗ (0)    │
                    │  Смешение слоёв │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │   ЭТАП 1        │
                    │   Выбор         │
                    │   стратегии     │
                    └────────┬────────┘
                             │
        ┌──────┬──────┬──────┼──────┬──────┬──────┐
        │      │      │      │      │      │      │
        A      B      C      D      E      F      G ◄── ВЫБРАН
        │      │      │      │      │      │      │
        ✗      ✗      ✗      ✗      ✗      ✗      ✓
                                                  │
                                         ┌────────▼────────┐
                                         │   ЭТАП 2        │
                                         │   highlightModel│
                                         │   ✓ ВЫПОЛНЕН    │
                                         └────────┬────────┘
                                                  │
                                         ┌────────▼────────┐
                                         │   ЭТАП 3        │
                                         │   Phase 2       │
                                         │   Core → Multi  │
                                         │   ⏳ В РАБОТЕ   │
                                         └────────┬────────┘
                                                  │
        ┌──────┬──────┬──────┬──────┬──────┬──────┼──────┐
        │      │      │      │      │      │      │      │
       2.1    2.2    2.3    2.4    2.5    2.6    2.7    ...
      завD   Graph  Rules  Proj   Dev   Owner  Crystal
        │      │      │      │      │      │      │
        ⏳     ⏳     ⏳     ⏳     ⏳     ⏳     ⏳
```

---

*Phase 2 ЗАВЕРШЕНА. Все шаги 2.0-2.7 выполнены.*

---

## Результат Phase 2: Crystal Test

```
═══════════════════════════════════════════════════════════════
                    CRYSTAL TEST: PASSED
═══════════════════════════════════════════════════════════════

Core можно использовать:
  ✓ Вне браузера (Node.js)
  ✓ Без DOM
  ✓ Без Three.js
  ✓ Для разных линз без переписывания логики

Это формальная архитектурная машина.
```

### Проверенные возможности

| Тест | Результат |
|------|-----------|
| GraphModel без DOM | ✓ 5 nodes, 5 edges |
| computeHighlight без Three.js | ✓ mode: selected |
| computeScope | ✓ characters → [characters, universe, vova] |
| Разные контексты → разные состояния | ✓ hover, scope, type |
| OwnershipGraph | ✓ 7 states, 3 computations |
| Экспорт в JSON | ✓ |
| Экспорт в Markdown | ✓ |

---

## РАЗВИЛКА после Phase 2

**ТЕКУЩЕЕ СОСТОЯНИЕ:**
- Core создан и работает
- Проекции определены (Visitor, Dev)
- OwnershipGraph документирует архитектуру
- Crystal Test пройден

**ВАРИАНТЫ:**

| ID | Название | Описание | Сложность |
|----|----------|----------|-----------|
| P3.1 | Интеграция Core в visitor.js | Заменить прямое использование на GraphModel | Средняя |
| P3.2 | VisitorProjection | Обернуть Three.js рендер в Projection | Высокая |
| P3.3 | DevProjection UI | Добавить переключатель линз в UI | Средняя |
| P3.4 | Тесты для Core | Unit-тесты с Jest/Vitest | Низкая |
| P3.5 | TypeScript для Core | Типизировать все модели | Средняя |
| P3.6 | OWL-экспорт | Экспорт GraphModel в OWL/RDF | Высокая |
| P3.7 | GraphRAG интеграция | Подготовка для LLM-анализа | Высокая |

**ОЖИДАНИЕ:** Выбор следующего шага

---

## Созданные файлы Core

| Файл | Описание |
|------|----------|
| `render/src/core/GraphModel.js` | Абстрактная модель графа с API |
| `render/src/core/Projection.js` | Базовый класс проекции + реестр |
| `render/src/core/DevProjection.js` | Прототип dev-линзы |
| `render/src/core/OwnershipGraph.js` | Граф владения состоянием |
| `render/src/core/index.js` | Экспорты Core |

### GraphModel API

```javascript
// Доступ к данным
getNodes()
getEdges()
getNodeById(nodeId)
getNeighbors(nodeId)
getNodesByType(type)
getNodeTypes()

// Вычисления
computeHighlight(context)
computeScope(hubId)
getRelatedNodeIdsByType(nodeId, type)

// Сериализация
toJSON()
static fromJSON(json)
```

### DevProjection API

```javascript
// Рендеринг
init(container)
render(graphModel, context)
updateHighlight(highlightState)
destroy()

// Экспорт
exportJSON(graphModel, context)
exportMarkdown(graphModel, context)
```
