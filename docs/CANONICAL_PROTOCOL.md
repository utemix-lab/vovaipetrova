# CANONICAL PROTOCOL — v1.0

**Дата:** 21 февраля 2026
**Статус:** Рабочий документ

---

## Назначение

Canonical Protocol — **единый механизм сверки** всех слоёв системы:
- Онтология (граф данных)
- Проекция (UI, визуализация)
- Код (реализация)
- Документация (описание)
- Нарратив (рассказ)

**Цель:** Сделать систему **человеко- и машиночитаемой**, связной и компактной.

---

## Принцип изоморфизма

> **Любой элемент системы должен иметь однозначное отображение во всех слоях.**

```
Онтология ↔ Код ↔ Документация ↔ UI ↔ Нарратив
```

Это исключает:
- Код без документации
- Документацию без кода
- UI-элементы без онтологической основы
- Нарратив, не связанный со структурой
- Скрытые заготовки и кодовый мусор

---

## Связь с Треками

Canonical Protocol **выводится из Треков**, а не подчиняет их:

| Track | Слой | Что описывает | Формат |
|-------|------|---------------|--------|
| **Track 0** | Meta | Платформа как продукт | Презентации, демо |
| **Track 1** | Ontology | Что существует | `node-types.json`, `relation-types.json` |
| **Track 2** | Schema | Как реализовано технически | `schema.json`, контракты |
| **Track 3** | Operators | Как действует | Функции, API |
| **Track 4** | Projection | Как отображается | CSS, компоненты, UI_STANDARDS.md |
| **Track 5** | Automation | Как добывает данные | Агенты, потоки |
| **Track 6** | Stacks | Как визуализирует | Метафоры, стеки |

**Протокол** — это **связи между Треками**, а не надстройка над ними.

---

## Статусы элементов

Каждый элемент системы (узел, функция, компонент, документ) имеет статус:

| Статус | Маркер | Значение | Действия |
|--------|--------|----------|----------|
| **canonical** | `@status: canonical` | Утверждено, стабильно | Изменения через RFC |
| **provisional** | `@status: provisional` | Работает, но не утверждено | Может измениться |
| **experimental** | `@status: experimental` | Эксперимент, заготовка | Может быть удалено |
| **deprecated** | `@status: deprecated` | Устарело | Будет удалено |

### Правила перехода

```
experimental → provisional → canonical
                    ↓
              deprecated → удаление
```

- **experimental → provisional:** Работает, прошло ревью
- **provisional → canonical:** Утверждено, задокументировано
- **canonical → deprecated:** Найдена замена, объявлено устаревшим
- **deprecated → удаление:** Через 2 релиза или по решению

### Маркировка в коде

```javascript
// === STORY SCREEN BINDING ===
// @status: canonical
// @track: 4
// @since: 2026-02-21
// @docs: UI_STANDARDS.md#story-screen
function bindNarrativeScreen(container) {
  // ...
}
```

```javascript
// === EXPERIMENTAL: New highlight mode ===
// @status: experimental
// @track: 4
// @expires: 2026-03-01
// @reason: Testing new hover behavior
function experimentalHighlight() {
  // ...
}
```

---

## Mapping Graph

Связи между слоями описываются явно:

```json
{
  "mappings": [
    {
      "source": { "track": 1, "type": "node_type", "id": "mechanism" },
      "target": { "track": 4, "type": "component", "id": "widget-nav" },
      "relation": "renders_as",
      "status": "canonical"
    },
    {
      "source": { "track": 1, "type": "node_type", "id": "character" },
      "target": { "track": 4, "type": "page_template", "id": "character" },
      "relation": "displayed_by",
      "status": "canonical"
    },
    {
      "source": { "track": 2, "type": "function", "id": "bindNarrativeScreen" },
      "target": { "track": 4, "type": "component", "id": "story-screen" },
      "relation": "implements",
      "status": "canonical"
    }
  ]
}
```

---

## Валидация целостности

### Автоматические проверки

1. **Код → Документация**
   - Каждая canonical-функция имеет `@docs` ссылку
   - Документ существует и содержит описание

2. **Онтология → Код**
   - Каждый `node_type` имеет обработчик в коде
   - Каждый `relation_type` имеет валидатор

3. **UI → Онтология**
   - Каждый UI-компонент ссылается на Track 1 или Track 4
   - Нет "висящих" компонентов без основы

4. **Статусы**
   - Нет `experimental` старше 30 дней без ревью
   - Нет `deprecated` старше 60 дней без удаления

### Команда валидации

```bash
node scripts/validate-protocol.cjs
```

---

## Философские векторы

Протокол открывает **направления исследования**, а не готовые ответы:

### Вектор 1: Семантика ↔ Код

```
Как семантика становится кодом?
Как код порождает семантику?
Где граница между описанием и реализацией?
```

**Наблюдения:**
- Онтология (Track 1) — чистая семантика
- Код (Track 2, 3) — чистая реализация
- Проекция (Track 4) — граница между ними
- Нарратив — семантика, выраженная через проекцию

### Вектор 2: Инвариант ↔ Проекция

```
Что остаётся неизменным?
Что может меняться?
Как изменения проекции влияют на понимание инварианта?
```

**Наблюдения:**
- Graph = invariant (Track 1)
- Projection = mutable (Track 4)
- Но проекция влияет на восприятие графа
- Разные проекции одного графа — разные понимания

### Вектор 3: Рефлексия ↔ Действие

```
Как система описывает себя?
Как описание влияет на систему?
Где граница между мета-уровнем и объектным уровнем?
```

**Наблюдения:**
- Track 0 — рефлексивный слой
- LLMReflectionEngine — машинная рефлексия
- Canonical Protocol — протокол рефлексии
- Рефлексия порождает изменения, изменения требуют рефлексии

### Вектор 4: Человек ↔ Машина

```
Что понимает человек?
Что понимает машина?
Как сделать понимание общим?
```

**Наблюдения:**
- Документация — для человека
- JSON-схемы — для машины
- Структурированные комментарии — для обоих
- Canonical Protocol — попытка общего языка

### Вектор 5: Локальное ↔ Глобальное

```
Как локальное изменение влияет на целое?
Как целое определяет локальное?
Где граница автономии компонента?
```

**Наблюдения:**
- Треки — автономные ракурсы
- Но связаны через Mapping Graph
- Изменение в Track 1 требует изменений в Track 4
- Протокол отслеживает эти связи

---

## Рабочие инструменты

### 1. Маркеры в коде

```javascript
// @status: canonical | provisional | experimental | deprecated
// @track: 0 | 1 | 2 | 3 | 4 | 5 | 6
// @since: YYYY-MM-DD
// @docs: path/to/doc.md#section
// @implements: node_type | relation_type | component
// @expires: YYYY-MM-DD (для experimental)
// @reason: описание (для experimental/deprecated)
```

### 2. Структура комментариев

```javascript
// === SECTION NAME ===
// Краткое описание секции
// @status: canonical
// @track: 4

// --- Subsection ---
// Детали подсекции
```

### 3. Документация

Каждый canonical-элемент имеет:
- Описание в соответствующем `*.md` файле
- Ссылку из кода через `@docs`
- Запись в Mapping Graph

### 4. Валидатор

```javascript
// scripts/validate-protocol.cjs
// Проверяет:
// - Все @status маркеры валидны
// - Все @docs ссылки существуют
// - Все experimental не просрочены
// - Все deprecated запланированы к удалению
```

---

## Интеграция с LLM

Canonical Protocol предоставляет LLM:

1. **Контекст** — какие элементы существуют и как связаны
2. **Статусы** — что стабильно, что экспериментально
3. **Ограничения** — что можно менять, что нельзя
4. **Направления** — философские векторы для рассуждений

### Промпт для LLM

```
Ты работаешь с системой, организованной по Canonical Protocol.

Статусы:
- canonical: не меняй без явного запроса
- provisional: можно улучшать
- experimental: можно переписывать
- deprecated: готовь к удалению

Треки:
- Track 1 (Ontology): что существует — не меняй
- Track 4 (Projection): как отображается — можно менять
- Track 2/3 (Schema/Operators): как работает — осторожно

Всегда проверяй @status перед изменением.
Всегда обновляй @docs после изменения.
```

---

## Выполненные шаги

1. **[x] Создать `scripts/validate-protocol.cjs`** — автоматическая валидация ✅
2. **[x] Добавить маркеры в ключевые функции** — bindNarrativeScreen, updateStoryWithHub ✅

---

## Перспективные шаги

Эти шаги станут актуальными при масштабировании системы:

| Шаг | Триггер | Описание |
|-----|---------|----------|
| Разметить больше функций | По ходу работы | Добавлять @status, @track, @docs при редактировании кода |
| Создать `mappings.json` | Подключение LLM | Связи между слоями для машинного понимания |
| Интегрировать в CI | Появление CI/CD | Валидация при коммите |
| Обновить LLMReflectionEngine | Подключение внешней LLM | Использовать протокол для контекста |

---

## Связанные документы

- [`ARCHITECTURE_TRACKS.md`](./ARCHITECTURE_TRACKS.md) — определение Треков
- [`UI_STANDARDS.md`](./UI_STANDARDS.md) — технические стандарты Track 4
- [`UI_NARRATIVE.md`](./UI_NARRATIVE.md) — нарративные описания UI-логик
- [`EXTENSION_POLICY.md`](../worlds/vovaipetrova/catalogs/EXTENSION_POLICY.md) — политика расширения графа
- [`STATUS.md`](../STATUS.md) — текущий статус системы
