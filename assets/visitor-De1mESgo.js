import{S as Rt,_ as un,A as qt,D as pn,L as fn,V as pe,M as Te,B as Ze,F as wt,a as qe,b as gn,c as et,d as tt,G as _t,e as Y,C as Ee,Q as bt,f as hn,P as mn,W as vn,I as $t,g as St,E as yn,h as wn,R as bn}from"./3d-force-graph-Qkr9Kv2e.js";import{V as K}from"./config-C8ziI3q8.js";const Be={DATA_ROOT:"/data",UNIVERSE_JSON:"/data/graph/universe.json",LOGOS:"/data/assets/logos",AVATARS:"/data/assets/avatars"},k={contractsPath:Be.DATA_ROOT,defaultRoute:"demo/visitor.demo.route.json",defaultGraphUrl:Be.UNIVERSE_JSON},$n=`${Be.AVATARS}/author-plug.png`,Z=K.node.minRadius,Sn=.07,En=.0016,xn=.08,Ln=.0013,In=.18,kn=2200,Tn={holdMs:420},j={...K.colors,nodeSelected:"#fbbf24",nodeStart:"#22d3ee",linkDefault:"#6b7280"},fe={type:"concept",visibility:"public",status:"expandable",semantics:{role:"content",abstraction:"medium"},rag:{index:!0,priority:.5}},Pn={knowledge:new Set(["domain","concept","character"]),system:new Set(["root","hub","module","spec","process","policy"]),all:null};document.body.classList.add("visitor-mode");Pi();const Cn=document.getElementById("graph");let R=null,d=null,zt=0,nt=null,se="all",ve="canon",Dt=k.defaultGraphUrl,$=new Map,U=new Map,J=null,Et=null,Bt=new Map,Ge=[],jt=[],Se=null,Ce=[],C=null,ae=!1,Pe=null;const xt={"domain-ai":{id:"practice-direction",label:"–†–µ–∂–∏—Å—Å—É—Ä–∞"}};let F=null,at=!1,ge=new Set,ee=null,xe=null,Le=null,P=null,je=new Map,z=null,_e=null,ot=null,ze=0,Wt=0,Lt=0,rt=!1;const ne=new Set,oe=new Set,Mn=new Rt(1,48,48),Ie=new Map,ye=new Map,ct=new Map,We=new Map,De=new Map,u=un()(Cn).backgroundColor(K.colors.background).showNavInfo(!1).nodeRelSize(Z).linkOpacity(.35).linkWidth(.6).linkDirectionalParticles(0);u.d3Force("link").distance(e=>zn(e));u.d3VelocityDecay(.08);u.d3AlphaDecay(.008);u.scene().add(new qt(16777215,.7));const Ot=new pn(16777215,.8);Ot.position.set(40,60,120);u.scene().add(Ot);const Ht=u.camera();Ht.fov=K.camera.fov;Ht.updateProjectionMatrix();const O=u.controls();O.enableDamping=!0;O.dampingFactor=.08;O.rotateSpeed=.6;O.zoomSpeed=.8;O.autoRotate=!0;O.autoRotateSpeed=In;O.minDistance=80;O.maxDistance=600;function D(e){return e&&typeof e=="object"?e.id:e}function Fe(e){let t=0;for(let n=0;n<e.length;n+=1)t=t*31+e.charCodeAt(n)|0;return Math.abs(t)}let ke=null;function re(e){return ke&&e.id===ke||d&&e.id===d.id?j.nodeSelected:e.isStart?j.nodeStart:at&&ge.has(e.id)?j.nodeSelected:j.nodeDefault}function Oe(e){return e.visualRadius&&Number.isFinite(e.visualRadius)?e.visualRadius:e.size&&Number.isFinite(e.size)?Math.min(K.node.maxRadius,Math.max(K.node.minRadius,e.size)):e.type==="hub"||e.type==="root"?Z*10:Z}function Ue(e){const t=String(e).toLowerCase();if(Ie.has(t))return Ie.get(t);const n=new Ee(e),i=new tt({color:n.clone().multiplyScalar(.6),emissive:n.clone(),emissiveIntensity:.2,roughness:.3,metalness:0,transparent:!1,opacity:1});return i.onBeforeCompile=s=>{s.uniforms.rimColor={value:n},s.uniforms.rimPower={value:2.2},s.uniforms.rimStrength={value:.9},s.fragmentShader=s.fragmentShader.replace("#include <output_fragment>",["float rim = pow(1.0 - max(dot(normalize(vNormal), normalize(vViewPosition)), 0.0), rimPower);","vec3 rimLight = rimColor * rim * rimStrength;","gl_FragColor = vec4(outgoingLight + rimLight, diffuseColor.a);"].join(`
`))},Ie.set(t,i),i}function An(e){const t=new Te(Mn,Ue(re(e))),n=Oe(e);if(t.scale.setScalar(n),ye.set(e.id,t),ct.set(e.id,n),!We.has(e.id)){const i=Fe(String(e.id))%1e3;We.set(e.id,i/1e3*Math.PI*2)}return t}function Nn(){const e=[new pe(1,0),new pe(.6,.18),new pe(.3,.52),new pe(.08,.9),new pe(0,1)],t=new fn(e,28);return t.computeVertexNormals(),t}const It=Nn();function Rn(e){const t=new Ze;t.setAttribute("position",new wt([0,0,0,0,0,0,0,0,0],3)),t.setAttribute("color",new wt([1,1,1,1,1,1,1,1,1],3));const n=new qe({vertexColors:!0,transparent:!0,opacity:.45,blending:gn}),i=new et(t,n),s=new tt({color:16777215,transparent:!1,opacity:1,depthWrite:!0}),a=new tt({color:16777215,transparent:!1,opacity:1,depthWrite:!0}),r=new Te(It,s),o=new Te(It,a),c=new _t;return c.add(i),c.add(r),c.add(o),c.userData={line:i,nozzleA:r,nozzleB:o},c}function qn(e,t,n){const{line:i,nozzleA:s,nozzleB:a}=e.userData,r=new Y(t.start.x,t.start.y,t.start.z),o=new Y(t.end.x,t.end.y,t.end.z),c=o.clone().sub(r),l=Math.max(1e-4,c.length()),S=c.clone().normalize(),f=1+Math.sin(ze*Ln+_n(n))*xn,h=$.get(D(n.source)),A=$.get(D(n.target)),L=oe.has(n);let w,b,m;if(L){const de=new Ee(j.nodeSelected);w=de,b=de,m=de}else w=new Ee(h?re(h):j.linkDefault),b=new Ee(A?re(A):j.linkDefault),m=new Ee(j.linkDefault);const y=i.geometry.getAttribute("color");y.array[0]=w.r,y.array[1]=w.g,y.array[2]=w.b,y.array[3]=m.r,y.array[4]=m.g,y.array[5]=m.b,y.array[6]=b.r,y.array[7]=b.g,y.array[8]=b.b,y.needsUpdate=!0,i.material.opacity=L?.9:.4;const v=h?Oe(h):Z,E=A?Oe(A):Z;let x=Math.min(l*.45,v*2)*f,I=Math.min(l*.45,E*2)*f;const we=v*.35,be=E*.35,$e=Math.max(.001,l-v-E),Me=x+I;if(Me>$e*.9){const de=$e*.9/Me;x*=de,I*=de}const rn=v*.45,cn=E*.45,vt=r.clone().add(S.clone().multiplyScalar(v-rn)),yt=o.clone().add(S.clone().multiplyScalar(-(E-cn))),Ae=vt.clone().add(S.clone().multiplyScalar(x)),Ne=yt.clone().add(S.clone().multiplyScalar(-I)),Je=Ae.clone().add(Ne).multiplyScalar(.5),V=i.geometry.getAttribute("position");V.array[0]=Ae.x,V.array[1]=Ae.y,V.array[2]=Ae.z,V.array[3]=Je.x,V.array[4]=Je.y,V.array[5]=Je.z,V.array[6]=Ne.x,V.array[7]=Ne.y,V.array[8]=Ne.z,V.needsUpdate=!0,s.visible=!0,a.visible=!0;const ln=new bt().setFromUnitVectors(new Y(0,1,0),S),dn=new bt().setFromUnitVectors(new Y(0,1,0),S.clone().multiplyScalar(-1));s.quaternion.copy(ln),a.quaternion.copy(dn),s.position.copy(vt),a.position.copy(yt),s.scale.set(we,x,we),a.scale.set(be,I,be),s.material.color.copy(w),a.material.color.copy(b)}function _n(e){const t=e.id||`${D(e.source)}-${D(e.target)}`;if(De.has(t))return De.get(t);const i=Fe(String(t))%1e3/1e3*Math.PI*2;return De.set(t,i),i}function zn(e){const t=K.link.baseLength,n=K.link.lengthVariance,s=Fe(String(e.id||`${D(e.source)}-${D(e.target)}`))%1e3/1e3;return t+(s-.5)*n*2}function Dn(e){const t={...fe.semantics,...e.semantics||{}},n={...fe.rag,...e.rag||{}};return{...e,type:e.type||fe.type,visibility:e.visibility||fe.visibility,status:e.status||fe.status,semantics:t,rag:n}}function Bn(e,t,n){if(!n||n==="all")return{nodes:e,edges:t};const i=Pn[n];if(!i)return{nodes:e,edges:t};const s=new Set,a=e.filter(o=>{const c=o.type||fe.type,l=i.has(c);return l&&s.add(o.id),l}),r=t.filter(o=>{const c=typeof o.source=="object"?o.source.id:o.source,l=typeof o.target=="object"?o.target.id:o.target;return s.has(c)&&s.has(l)});return{nodes:a,edges:r}}u.nodeLabel(e=>e.label||e.id);u.nodeColor(e=>re(e));u.nodeThreeObject(e=>An(e));u.nodeThreeObjectExtend(!1);u.nodeVal(e=>Oe(e)/Z);u.linkThreeObject(e=>Rn());u.linkPositionUpdate((e,t,n)=>qn(e,t,n));u.linkColor(e=>oe.has(e)?j.highlight:j.linkDefault);u.linkWidth(e=>oe.has(e)?1.6:.6);const B=(()=>{let e=null,t=null,n=null,i=null,s=null,a=null,r=!1;const o=80,c=.25,l=200,S=800,g=.92;let f=0,h=l,A=0,L=l;function w(){if(r)return;e=new AudioContext,t=e.createOscillator(),t.type="sine",t.frequency.value=o,n=e.createOscillator(),n.type="sine",n.frequency.value=o*2,i=e.createOscillator(),i.type="triangle",i.frequency.value=o*1.5;const v=e.createGain();v.gain.value=1;const E=e.createGain();E.gain.value=1,t.connect(E),E.connect(v);const x=e.createGain();x.gain.value=.3,n.connect(x),x.connect(v);const I=e.createGain();I.gain.value=.15,i.connect(I),I.connect(v),a=e.createBiquadFilter(),a.type="lowpass",a.frequency.value=l,a.Q.value=2,s=e.createGain(),s.gain.value=0,v.connect(a),a.connect(s),s.connect(e.destination),t.start(),n.start(),i.start(),r=!0,console.log("[MotionSound] Initialized")}async function b(){r||w(),e&&e.state==="suspended"&&await e.resume()}function m(v){if(!v||v.length===0)return 0;let E=0,x=0;return v.forEach(I=>{const we=I.vx||0,be=I.vy||0,$e=I.vz||0,Me=Math.sqrt(we*we+be*be+$e*$e);E+=Me,x++}),x>0?E/x:0}function y(v){if(!(!r||!e||e.state!=="running")){if(rt)A=0,L=l;else{const E=m(v),x=Math.min(1,E/2.5);A=x*c,L=l+x*(S-l);const I=1+x*.15;t&&(t.frequency.value=o*I),n&&(n.frequency.value=o*2*I),i&&(i.frequency.value=o*1.5*I)}f=f*g+A*(1-g),h=h*g+L*(1-g),s&&(s.gain.value=f),a&&(a.frequency.value=h)}}return{resumeIfNeeded:b,tick:y}})();function jn(e){$=new Map(e.nodes.map(t=>[t.id,t])),U=new Map,e.links.forEach(t=>{const n=D(t.source),i=D(t.target);U.has(n)||U.set(n,new Set),U.has(i)||U.set(i,new Set),U.get(n).add(i),U.get(i).add(n)})}function M(e){ne.clear(),oe.clear(),e&&(ne.add(e),u.graphData().links.forEach(n=>{const i=D(n.source),s=D(n.target);if(i===e.id||s===e.id){oe.add(n);const a=i===e.id?s:i,r=$.get(a);r&&ne.add(r)}}))}let te=null;u.onNodeHover(e=>{te&&te!==e?.id&&(N(te,!1),he(te,!1),Ct(te,!1),te=null),e!==F&&(F=e||null,M(F),u.refresh(),F&&(N(F.id,!0),he(F.id,!0),Ct(F.id,!0),te=F.id))});u.onNodeClick(e=>{_(),B.resumeIfNeeded(),G(e.id)});u.onNodeDrag(e=>{_(),rt=!0,e.fx=e.x,e.fy=e.y,e.fz=e.z});u.onNodeDragEnd(e=>{rt=!1,e.fx=null,e.fy=null,e.fz=null,B.resumeIfNeeded()});function Wn(e){const t=e*En;ye.forEach((n,i)=>{const s=ct.get(i);if(!s)return;const a=We.get(i)||0,r=1+Math.sin(t+a)*Sn;n.scale.setScalar(s*r)})}function On(e){const t=e-Wt>kn;O.autoRotate=t,t&&(Lt+=25e-5,u.scene().rotation.y=Lt)}function _(){Wt=performance.now(),O.autoRotate=!1}async function He(e){const t=`${k.contractsPath}/routes/${e}`;try{const n=await fetch(t+"?t="+Date.now());if(!n.ok)throw new Error(`Failed to load: ${t}`);const i=await n.json();lt(i)}catch(n){console.error("[Visitor] Failed to load route:",n)}}async function Vt(){const e=Qn(Dt);try{const t=await fetch(Qe(e));if(!t.ok)throw new Error(`Failed to load: ${e}`);const n=await t.json();nt=n;const i=Gt(n,se);lt(i),console.log("[Visitor] Loaded Universe Graph with",i.nodes.length,"nodes")}catch(t){console.error("[Visitor] Failed to load Universe Graph:",t),He(k.defaultRoute)}}async function Hn(){const e=`${k.contractsPath}/ui/widgets/domains.json`;try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}`);J=await t.json(),console.log("[Visitor] Loaded domain widgets:",J.widgets?.length)}catch(t){console.warn("[Visitor] Domain widgets not available:",t.message),J=null}}function Vn(e){return(e||"").split(`
`).map(t=>t.trim()).filter(t=>t.length>0).map(t=>{try{return JSON.parse(t)}catch{return console.warn("[Visitor] Failed to parse JSONL line:",t),null}}).filter(Boolean)}function kt(e,t){const i=((e||"").split("/").pop()||"").replace(/\.jsonl?$/i,"");return t==="catalog"&&i.endsWith("_catalog")?i.slice(0,-8):t==="registry"&&i.endsWith("_registry")?i.slice(0,-9):i}async function Tt(e){const t=`${k.contractsPath}/${e}`,n=await fetch(Qe(t));if(!n.ok)throw new Error(`HTTP ${n.status}`);return n.json()}async function Ke(e){const t=`${k.contractsPath}/${e}`,n=await fetch(Qe(t));if(!n.ok)throw new Error(`HTTP ${n.status}`);const i=await n.text();return Vn(i)}function Pt(e){Et=e.registries.pointer_tags||null,Bt=new Map((Et?.tags||[]).map(t=>[t.tag,t])),Ge=e.catalogs.ai||[],jt=e.catalogs.practice_participation||[]}async function Gn(){if(Se)return Se;const e=`${k.contractsPath}/manifests/assets.manifest.json`;try{const t=await fetch(Qe(e));if(!t.ok)throw new Error(`HTTP ${t.status}`);const i=(await t.json()).exports||{},s=i.catalogs||[],a=i.registries||[],r={catalogs:{},registries:{}};return await Promise.all([...s.map(async o=>{const c=kt(o,"catalog");r.catalogs[c]=await Ke(o)}),...a.map(async o=>{const c=kt(o,"registry");r.registries[c]=await Tt(o)})]),Se=r,Pt(r),console.log("[Visitor] Loaded exports:",Object.keys(r.catalogs).length,"catalogs"),r}catch(t){console.warn("[Visitor] Exports manifest not available:",t.message);const n={catalogs:{},registries:{}};try{n.registries.pointer_tags=await Tt("exports/pointer_tags_registry.json")}catch(i){console.warn("[Visitor] Pointer tags registry not available:",i.message)}try{n.catalogs.ai=await Ke("exports/ai_catalog.jsonl")}catch(i){console.warn("[Visitor] AI catalog not available:",i.message)}try{n.catalogs.practice_participation=await Ke("exports/practice_participation.jsonl")}catch(i){console.warn("[Visitor] Practice participation not available:",i.message)}return Se=n,Pt(n),Se}}async function Fn(){console.log("[Visitor] Reloading...");const e=document.getElementById("step-indicator");e&&(e.textContent="Reloading..."),ve==="demo"?await He(k.defaultRoute):await Vt(),console.log("[Visitor] Reloaded!")}function Gt(e,t){const n=(e.nodes||[]).map(a=>Dn(a)),i=(e.edges||[]).map(a=>({...a,type:a.type||"relates"})),s=Bn(n,i,t);return{id:"universe-graph",title:e.meta?.description||"Universe Graph",nodes:s.nodes.map(a=>({...a,label:a.label,position:a.position,story:{text:a.story||"",refs:[]},system:{text:a.system||"",refs:[]},service:Un(a.service)})),edges:s.edges.map(a=>({id:a.id,source:a.source,target:a.target,type:"NEXT"})),start_node_id:s.nodes[0]?.id||"universe"}}function Un(e){return e?typeof e=="string"?{text:e,actions:[]}:typeof e=="object"?{text:e.text||"",actions:Array.isArray(e.actions)?e.actions:[]}:{text:String(e),actions:[]}:{text:"",actions:[]}}function Qn(e){return!e.startsWith("http")&&!e.startsWith("/")?`${k.contractsPath}/${e}`:e}function Qe(e){const t=new URL(e,window.location.href);return t.searchParams.set("t",Date.now().toString()),t.toString()}function lt(e){R=e;const t={nodes:e.nodes.map(i=>{const s=Fe(i.id)%100/100*2,a=Z+s,r=i.type==="hub"||i.type==="root"?Z*4:a;return{...i,isStart:i.id===e.start_node_id,visualRadius:r}}),links:e.edges.map(i=>({id:i.id,source:i.source,target:i.target,type:i.type}))};ye.clear(),ct.clear(),We.clear(),De.clear(),Ie.clear(),u.graphData(t),jn(t),Xn(t.nodes.length,t.links.length);const n=e.start_node_id||e.nodes[0]?.id;G(n),setTimeout(()=>{u.zoomToFit(800,150)},200),console.log("[Visitor] Route loaded:",e.title)}function Xn(e,t){const n=document.getElementById("graph-stats");n&&(n.textContent=`${e} nodes | ${t} edges`)}function G(e){const t=$.get(e);!t||!R||(d=t,zt=R.nodes.findIndex(n=>n.id===e),Ie.clear(),ye.forEach((n,i)=>{const s=$.get(i);s&&(n.material=Ue(re(s)))}),Kn(),Ti(),M(d),u.refresh())}function dt(){if(!R||!d)return;const e=R.edges.find(t=>t.source===d.id&&t.type==="NEXT");e&&G(e.target)}function Ft(){if(!R||!d)return;const e=R.edges.find(t=>t.target===d.id&&t.type==="NEXT");e&&G(e.source)}function Yn(){return!R||!d?!1:R.edges.some(e=>e.source===d.id&&e.type==="NEXT")}function Jn(){return!R||!d?!1:R.edges.some(e=>e.target===d.id&&e.type==="NEXT")}function Kn(){if(!d)return;const e=document.getElementById("story-panel"),t=document.getElementById("system-panel"),n=document.getElementById("service-panel"),i=d.service?.text||"",s=Ve(i).length>0,a=d.id==="domain-ai";if(a){const r=Ve(i);(!C||!r.includes(C))&&(C=r[0]||null),C&&(ae=!0)}if(d.id==="domains"&&J?.widgets?.length)oi(e,d.story);else if(d.id==="practices")ri(e,d.story);else if(d.id==="characters")ci(e,d.story);else if(ei(d)){Zn(e,d),Re(t,{text:"–†–∞–±–æ—á–µ–µ –æ–∫–Ω–æ"}),ie(n,{text:"–†–∞–±–æ—á–µ–µ –æ–∫–Ω–æ",actions:[]}),me();return}else if(ni(d)){si(e,d),Re(t,{text:"–†–∞–±–æ—á–µ–µ –æ–∫–Ω–æ"}),ie(n,{text:"–†–∞–±–æ—á–µ–µ –æ–∫–Ω–æ",actions:[]}),me();return}else ti(d)?ai(e,d):di(d)?li(e,d.story,d):(e?.querySelector(".panel-content")?.classList.remove("story-compact"),ae&&xt[d.id]?yi(e,d.story,xt[d.id]):s&&!a?wi(e,d.story,d.system):Re(e,d.story));ae&&s?(bi(t,i),ie(n,{text:""})):(Re(t,d.system),ie(n,d.service)),me()}function Zn(e,t){const n=e?.querySelector(".panel-content");if(!n)return;ce(),n.classList.remove("story-compact");const i=ut(t),s="–û–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–π –±–ª–æ–∫",a=q(t?.id,"domain"),r=q(t?.id,"practice"),o=q(t?.id,"workbench");let c="";i&&(c+=`
      <div class="node-toc">
        <div class="node-widget node-widget--scope node-widget--root vova-scope-widget" data-node-id="${p(t.id)}" title="${p(t.label||t.id)}">
          <div class="widget-frame">
            ${T(i,"widget")}
          </div>
        </div>
      </div>`),c+=`<div class="text">${p(s)}</div>`,c+='<div class="section-title">–ö–æ–Ω—Ç–∏–Ω–µ–Ω—Ç—ã</div>',c+='<div class="domain-widgets inline-widgets">',c+=a.map(l=>{const S=$.get(l)?.label||l;return`
      <div class="domain-widget highlight-widget widget--lever" data-node-id="${l}" title="${p(S)}">
        <div class="widget-frame">
          ${T(pt(),"domain")}
        </div>
      </div>`}).join(""),c+="</div>",c+='<div class="section-title">–ü—Ä–∞–∫—Ç–∏–∫–∏</div>',c+='<div class="domain-widgets inline-widgets">',c+=r.map(l=>{const S=$.get(l)?.label||l;return`
      <div class="domain-widget highlight-widget widget--lever" data-node-id="${l}" title="${p(S)}">
        <div class="widget-frame">
          ${T(Xe(),"practice")}
        </div>
      </div>`}).join(""),c+="</div>",c+='<div class="section-title">–í–æ—Ä–∫–±–µ–Ω—á–∏</div>',c+='<div class="domain-widgets inline-widgets">',c+=o.map(l=>{const S=$.get(l)?.label||l;return`
      <div class="domain-widget highlight-widget widget--lever${it(l)?" domain-widget--shared":""}" data-node-id="${l}" title="${p(S)}">
        <div class="widget-frame">
          ${T(st(),"workbench")}
        </div>
      </div>`}).join(""),c+="</div>",n.innerHTML=c,ht(n),hi(n,t),le(n),X(n)}function ei(e){return e&&e.type==="character"}function ti(e){return e&&e.type==="domain"}function ni(e){return e&&e.type==="workbench"}function ii(e){const t=["character-vova","character-vasya"];return[...e].sort((n,i)=>{const s=t.indexOf(n),a=t.indexOf(i);return s!==-1||a!==-1?(s===-1?99:s)-(a===-1?99:a):n.localeCompare(i)})}function it(e){return q(e,"character").length>1}function si(e,t){const n=e?.querySelector(".panel-content");if(!n)return;ce(),n.classList.remove("story-compact");const i=t.label||t.id,s=st(t.id),a=ft(),r=it(t.id)?" node-widget--shared":"",o=ii(q(t.id,"character")),c=q(t.id,"domain"),l=q(t.id,"practice"),S=q(t.id,"workbench").filter(f=>f!==t.id);let g="";g+=`
    <div class="node-toc">
      <div class="node-toc-row">
        <div class="node-widget node-widget--static node-widget--root${r}" title="${p(i)}">
          <div class="widget-frame">
            ${T(s,"workbench")}
          </div>
        </div>
        ${o.map(f=>{const h=$.get(f)?.label||f;return`
            <div class="node-widget node-widget--static node-widget--root node-widget--lever" title="${p(h)}">
              <div class="widget-frame">
                ${T(a,"character")}
              </div>
            </div>`}).join("")}
      </div>
    </div>`,g+='<div class="text">–û–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–π –±–ª–æ–∫</div>',c.length&&(g+='<div class="section-title">–ö–æ–Ω—Ç–∏–Ω–µ–Ω—Ç—ã</div>',g+='<div class="domain-widgets inline-widgets">',g+=c.map(f=>{const h=$.get(f)?.label||f;return`
        <div class="domain-widget highlight-widget widget--lever" data-node-id="${f}" title="${p(h)}">
        <div class="widget-frame">
          ${T(pt(),"domain")}
        </div>
        </div>`}).join(""),g+="</div>"),l.length&&(g+='<div class="section-title">–ü—Ä–∞–∫—Ç–∏–∫–∏</div>',g+='<div class="domain-widgets inline-widgets">',g+=l.map(f=>{const h=$.get(f)?.label||f;return`
        <div class="domain-widget highlight-widget widget--lever" data-node-id="${f}" title="${p(h)}">
        <div class="widget-frame">
          ${T(Xe(),"practice")}
        </div>
        </div>`}).join(""),g+="</div>"),S.length&&(g+='<div class="section-title">–í–æ—Ä–∫–±–µ–Ω—á–∏</div>',g+='<div class="domain-widgets inline-widgets">',g+=S.map(f=>{const h=$.get(f)?.label||f;return`
        <div class="domain-widget highlight-widget widget--lever${it(f)?" domain-widget--shared":""}" data-node-id="${f}" title="${p(h)}">
        <div class="widget-frame">
          ${T(st(),"workbench")}
        </div>
        </div>`}).join(""),g+="</div>"),n.innerHTML=g,ht(n),le(n),X(n)}function ai(e,t){const n=e?.querySelector(".panel-content");if(!n)return;ce(),n.classList.remove("story-compact");const i=ut(t),s="–û–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–π –±–ª–æ–∫",a=Jt(t?.id),r=q(t?.id,"character"),o=q(t?.id,"practice");let c="";i&&(c+=`
      <div class="node-toc">
        <div class="node-widget node-widget--static node-widget--root" title="${p(t.label||t.id)}">
          <div class="widget-frame">
            ${T(i,"widget")}
          </div>
        </div>
      </div>`),c+=`<div class="text">${p(s)}</div>`,c+=`<div class="potential-section">
    <div class="potential-title">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª</div>`,r.length&&(c+='<div class="potential-group-title">–ü—Ä–æ–≤–æ–¥–Ω–∏–∫–∏</div>',c+='<div class="potential-buttons">',c+=r.map(l=>{const S=$.get(l)?.label||l;return`
        <div class="domain-widget highlight-widget widget--lever" data-node-id="${l}" title="${p(S)}">
        <div class="widget-frame">
          ${T(ft(),"character")}
        </div>
        </div>`}).join(""),c+="</div>"),o.length&&(c+='<div class="potential-group-title">–ü—Ä–∞–∫—Ç–∏–∫–∏</div>',c+='<div class="potential-buttons">',c+=o.map(l=>{const S=$.get(l)?.label||l;return`
        <div class="domain-widget highlight-widget widget--lever" data-node-id="${l}" title="${p(S)}">
        <div class="widget-frame">
          ${T(Xe(),"practice")}
        </div>
        </div>`}).join(""),c+="</div>"),a&&(c+='<div class="potential-group-title">–î–∞–Ω–Ω—ã–µ</div>',c+=`<div class="potential-tags">
      <span class="pointer-tag" data-tag="${p(a)}">${p(a)}</span>
    </div>`),c+="</div>",n.innerHTML=c,H(n),le(n),X(n),X(n),X(n),X(n),ht(n),X(n)}function oi(e,t){const n=e?.querySelector(".panel-content");if(!n)return;ce(),n.classList.add("story-compact");let i=`<div class="text">${Q(t?.text||"")}</div>`;i+='<div id="mini-cube-container"></div>',i+='<div class="domain-widgets domain-grid">';for(const a of J.widgets)i+=`
      <div class="domain-widget widget--lever" data-node-id="${a.nodeId}" title="${a.label}">
        <div class="widget-frame">
          ${T(pt(a.nodeId),"domain")}
        </div>
      </div>`;i+="</div>",n.innerHTML=i,H(n),le(n);const s=document.getElementById("mini-cube-container");s&&gt("cube",s,J.widgets.map(a=>a.nodeId),"domains"),n.querySelectorAll(".domain-widget").forEach(a=>{a.addEventListener("mouseenter",()=>{const r=a.dataset.nodeId,o=$.get(r);N(r,!0),W(r,!0),o&&(M(o),u.refresh())}),a.addEventListener("mouseleave",()=>{const r=a.dataset.nodeId;N(r,!1),W(r,!1),M(null),u.refresh()}),a.addEventListener("click",()=>{_(),B.resumeIfNeeded(),G(a.dataset.nodeId)})})}function ri(e,t){const n=e?.querySelector(".panel-content");if(!n)return;ce(),n.classList.add("story-compact");const i=[...$.values()].filter(r=>r.type==="practice");let s=`<div class="text">${Q(t?.text||"")}</div>`;s+='<div id="mini-cube-container"></div>',s+='<div class="domain-widgets practice-grid">';for(const r of i)s+=`
      <div class="domain-widget widget--lever" data-node-id="${r.id}" title="${r.label}">
        <div class="widget-frame">
          ${T(Xe(r.id),"practice")}
        </div>
      </div>`;s+="</div>",n.innerHTML=s,H(n),le(n);const a=document.getElementById("mini-cube-container");a&&gt("icosa",a,i.map(r=>r.id),"practices"),n.querySelectorAll(".domain-widget").forEach(r=>{r.addEventListener("mouseenter",()=>{const o=r.dataset.nodeId,c=$.get(o);N(o,!0),W(o,!0),c&&(M(c),u.refresh())}),r.addEventListener("mouseleave",()=>{const o=r.dataset.nodeId;N(o,!1),W(o,!1),M(null),u.refresh()}),r.addEventListener("click",()=>{_(),B.resumeIfNeeded(),G(r.dataset.nodeId)})})}function ci(e,t){const n=e?.querySelector(".panel-content");if(!n)return;ce(),n.classList.add("story-compact");const i=[...$.values()].filter(r=>r.type==="character");let s=`<div class="text">${Q(t?.text||"")}</div>`;s+='<div id="mini-cube-container"></div>',s+='<div class="domain-widgets character-grid">';for(const r of i)s+=`
      <div class="domain-widget widget--lever" data-node-id="${r.id}" title="${r.label}">
        <div class="widget-frame">
          ${T(ft(),"character")}
        </div>
      </div>`;s+="</div>",n.innerHTML=s,H(n),le(n);const a=document.getElementById("mini-cube-container");a&&gt("icosa",a,i.map(r=>r.id),"characters"),n.querySelectorAll(".domain-widget").forEach(r=>{r.addEventListener("mouseenter",()=>{const o=r.dataset.nodeId,c=$.get(o);N(o,!0),W(o,!0),c&&(M(c),u.refresh())}),r.addEventListener("mouseleave",()=>{const o=r.dataset.nodeId;N(o,!1),W(o,!1),M(null),u.refresh()}),r.addEventListener("click",()=>{_(),B.resumeIfNeeded(),G(r.dataset.nodeId)})})}function li(e,t,n){const i=e?.querySelector(".panel-content");if(!i)return;ce(),i.classList.remove("story-compact");const s=ut(n);let a="";s&&(a+=`
      <div class="node-toc">
        <div class="node-widget node-widget--static node-widget--root" title="${p(n.label||n.id)}">
          <div class="widget-frame">
            ${T(s,"widget")}
          </div>
        </div>
      </div>`),a+=`<div class="text">${Q(t?.text||"")}</div>`,i.innerHTML=a,H(i),le(i),X(i)}function di(e){return e&&["domain","practice","character","workbench"].includes(e.type)}function ut(e){return e?e.type==="domain"?J?.widgets?.length&&!J.widgets.some(n=>n.nodeId===e.id)?null:`${k.contractsPath}/assets/icons/domains/plug.png`:e.type==="practice"?`${k.contractsPath}/assets/practices/practice-plug.png`:e.type==="character"?`${k.contractsPath}/assets/avatars/characters/character-plug.png`:e.type==="workbench"?`${k.contractsPath}/assets/workbenches/workbench-plug.png`:null:null}function pt(e){return`${k.contractsPath}/assets/icons/domains/plug.png`}function Xe(e){return`${k.contractsPath}/assets/practices/practice-plug.png`}function ft(){return`${k.contractsPath}/assets/avatars/characters/character-plug.png`}function st(e){return`${k.contractsPath}/assets/workbenches/workbench-plug.png`}function T(e,t="icon"){const n=p(t);return`<img src="${e}" data-default-src="${e}" data-hover-src="${$n}" alt="${n}" />`}function N(e,t){const n=$.get(e);if(!n)return;t?ke=e:ke===e&&(ke=null);const i=ye.get(e);i&&(i.material=Ue(re(n)))}function he(e,t){const n=document.querySelector(`.domain-widget[data-node-id="${e}"]`);n&&(t?n.classList.add("widget-highlighted"):n.classList.remove("widget-highlighted"))}function gt(e,t,n,i){if(!n||n.length===0)return;ot=i;const s=220,a=s,r=s;xe=new hn,Le=new mn(50,a/r,.1,100),Le.position.z=4,P=new vn({alpha:!0,antialias:!0}),P.setSize(a,r),P.setPixelRatio(Math.min(window.devicePixelRatio,2)),t.appendChild(P.domElement),z=new _t,xe.add(z);let o=[];if(e==="cube")o=[[-1,-1,-1],[1,-1,-1],[1,1,-1],[-1,1,-1],[-1,-1,1],[1,-1,1],[1,1,1],[-1,1,1]].map(b=>b.map(m=>m*.85));else{const b=new $t(1).getAttribute("position").array,m=[];for(let v=0;v<b.length;v+=3){const E=[b[v],b[v+1],b[v+2]],x=E.map(I=>I.toFixed(3)).join(",");if(m.find(I=>I.key===x)||m.push({key:x,v:E}),m.length>=12)break}const y=1.275;o=m.map(v=>v.v.map(E=>E*y))}const c=new Rt(.12,16,16),l=new St({color:7041664});n.slice(0,o.length).forEach((w,b)=>{const m=new Te(c,l.clone());m.position.set(...o[b]),m.userData.nodeId=w,z.add(m),je.set(w,m)});const g=new St({color:10265519}),f=new Te(c,g);if(f.position.set(0,0,0),f.userData.nodeId=i,z.add(f),je.set(i,f),e==="cube"){const w=[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]],b=new qe({color:4937059,opacity:.5,transparent:!0});w.forEach(([m,y])=>{if(!o[m]||!o[y])return;const v=new Ze().setFromPoints([new Y(...o[m]),new Y(...o[y])]),E=new et(v,b);z.add(E)})}else{const w=new $t(1.275),b=new yn(w),m=new qe({color:4937059,opacity:.45,transparent:!0}),y=new wn(b,m);z.add(y)}if(e==="cube"){const w=new qe({color:3621201,opacity:.3,transparent:!0});o.forEach(b=>{const m=new Ze().setFromPoints([new Y(0,0,0),new Y(...b)]),y=new et(m,w);z.add(y)})}xe.add(new qt(16777215,.8));const h=new bn,A=new pe;let L=null;P.domElement.addEventListener("mousemove",w=>{const b=P.domElement.getBoundingClientRect();A.x=(w.clientX-b.left)/b.width*2-1,A.y=-((w.clientY-b.top)/b.height)*2+1,h.setFromCamera(A,Le);const m=h.intersectObjects(z.children.filter(y=>y.isMesh));if(m.length>0){const y=m[0].object;if(L!==y){if(L){const x=L.userData.nodeId;W(x,!1),N(x,!1),he(x,!1),M(null),u.refresh()}L=y;const v=y.userData.nodeId;W(v,!0),N(v,!0),he(v,!0);const E=$.get(v);E&&(M(E),u.refresh())}}else if(L){const y=L.userData.nodeId;W(y,!1),N(y,!1),he(y,!1),M(null),u.refresh(),L=null}}),P.domElement.addEventListener("click",()=>{if(L){const w=L.userData.nodeId;_(),B.resumeIfNeeded(),G(w)}}),P.domElement.addEventListener("mouseleave",()=>{if(L){const w=L.userData.nodeId;W(w,!1),N(w,!1),he(w,!1),M(null),u.refresh(),L=null}}),Ut()}function W(e,t){const n=je.get(e);if(n)if(t)n.material.color.setHex(16498468),n.scale.setScalar(1.5);else{const i=e===ot;n.material.color.setHex(i?10265519:7041664),n.scale.setScalar(1)}}function Ut(){P&&(_e=requestAnimationFrame(Ut),z&&(z.rotation.y+=.003,z.rotation.x=Math.sin(Date.now()*3e-4)*.1),P.render(xe,Le))}function ce(){_e&&(cancelAnimationFrame(_e),_e=null),P&&(P.dispose(),P.domElement.remove(),P=null),xe=null,Le=null,z=null,je.clear(),ot=null}function Ct(e,t){P&&W(e,t)}const Qt=/\b(?:cap|method|arch|provider|domain|model|country|practice):[a-z0-9_:-]+\b/gi;function ui(e){const[t,...n]=e.split(":");return{prefix:(t||"").toLowerCase(),key:(n.join(":")||"").toLowerCase()}}function pi(e){const{key:t}=ui(e);return t.replace(/[_-]+/g," ").trim()}function fi(e){let t="",n=0;return e.replace(Qt,(i,s)=>{const a=e.slice(n,s);return t+=p(a),t+=`<span class="pointer-tag" data-tag="${i}">${p(i)}</span>`,n=s+i.length,i}),t+=p(e.slice(n)),t}function Q(e){return(e||"").split(`
`).map(n=>fi(n)).join("<br>")}function Ve(e){return(e||"").match(Qt)||[]}function gi(e){return Ve(e).map(n=>`<span class="pointer-tag" data-tag="${n}">${p(n)}</span>`).join(" ")}function ht(e){e.querySelectorAll(".highlight-widget").forEach(t=>{t.addEventListener("mouseenter",()=>{const n=t.dataset.nodeId,i=$.get(n);N(n,!0),i&&(M(i),u.refresh())}),t.addEventListener("mouseleave",()=>{const n=t.dataset.nodeId;N(n,!1),M(null),u.refresh()}),t.addEventListener("click",n=>{n.preventDefault();const i=t.dataset.nodeId,s=$.get(i);if(s)if(s.type==="domain"){const a=Jt(s.id);a&&Kt(a,"widget")}else s.type==="workbench"&&(_(),B.resumeIfNeeded(),G(s.id))})})}function hi(e,t){const n=e.querySelector(".vova-scope-widget");if(!n||!t)return;const i=new Set([t.id,...q(t.id,"domain"),...q(t.id,"practice"),...q(t.id,"workbench")]);n.addEventListener("mouseenter",()=>{n.classList.add("scope-active"),Mt(e,!0),mi(i)}),n.addEventListener("mouseleave",()=>{n.classList.remove("scope-active"),Mt(e,!1),vi()})}function Xt(e,t){e&&(t?(ee&&ee!==e&&Xt(ee,!1),ee=e,e.classList.add("widget--shifted"),e.style.setProperty("--lever-offset","-10px"),document.body.classList.add("scene-lever-active")):(ee===e&&(ee=null),e.classList.remove("widget--shifted"),e.style.removeProperty("--lever-offset"),ee||document.body.classList.remove("scene-lever-active")))}function le(e){e.querySelectorAll(".widget--lever, .node-widget--lever").forEach(t=>{if(t.dataset.leverBound)return;t.dataset.leverBound="true";let n=null,i=!1,s=0,a=0,r=0,o=null;const c=()=>{n&&(clearTimeout(n),n=null)},l=g=>{if(!i)return;const f=g.clientY-s,h=Math.max(-10,Math.min(0,a+f));r=h,t.style.setProperty("--lever-offset",`${h}px`)},S=()=>{if(i){const g=r<=-6;Xt(t,g)}t.classList.remove("lever-dragging"),i=!1,c(),o!==null&&t.hasPointerCapture(o)&&t.releasePointerCapture(o),o=null};t.addEventListener("pointerdown",g=>{g.button&&g.button!==0||(s=g.clientY,a=t.classList.contains("node-widget--shifted")?-10:0,r=a,o=g.pointerId,t.setPointerCapture&&t.setPointerCapture(o),n=setTimeout(()=>{i=!0,t.classList.add("lever-dragging")},Tn.holdMs))}),t.addEventListener("pointermove",l),t.addEventListener("pointerup",S),t.addEventListener("pointercancel",S),t.addEventListener("click",g=>{(t.classList.contains("node-widget--shifted")||i)&&(g.preventDefault(),g.stopPropagation())})})}function X(e){e.querySelectorAll(".widget-frame img[data-hover-src]").forEach(t=>{const n=t.closest(".domain-widget, .node-widget");if(!n||n.dataset.swapBound)return;n.dataset.swapBound="true";const i=t.dataset.defaultSrc,s=t.dataset.hoverSrc,a=()=>{s&&(t.src=s,n.classList.add("emblem-swap-active"))},r=()=>{i&&(t.src=i,n.classList.remove("emblem-swap-active"))};n.addEventListener("mouseenter",a),n.addEventListener("mouseleave",r)})}function Mt(e,t){e.querySelectorAll(".highlight-widget").forEach(n=>{n.classList.toggle("widget-scope-highlighted",t)})}function mi(e){at=!0,ge=new Set(e),ne.clear(),oe.clear();const t=u.graphData();t.nodes.forEach(n=>{ge.has(n.id)&&ne.add(n)}),t.links.forEach(n=>{const i=D(n.source),s=D(n.target);if(ge.has(i)||ge.has(s)){oe.add(n);const a=$.get(i),r=$.get(s);a&&ne.add(a),r&&ne.add(r)}}),Yt(),u.refresh()}function vi(){at=!1,ge=new Set,M(F),Yt(),u.refresh()}function Yt(){ye.forEach((e,t)=>{const n=$.get(t);n&&(e.material=Ue(re(n)))})}function q(e,t){if(!e||!U.has(e))return[];const n=[];return U.get(e).forEach(i=>{$.get(i)?.type===t&&n.push(i)}),n}function Jt(e){if(!e||!e.startsWith("domain-"))return null;const t=e.replace("domain-","");return t?`domain:${t}`:null}function yi(e,t,n){const i=e?.querySelector(".panel-content");if(!i)return;const s=t?.text||"",a=`Practice: ${n.label} (${n.id})`;let r=`<div class="practice-hint">${p(a)}</div>`;r+=`<div class="text">${Q(s)}</div>`,t?.refs?.length&&(r+=`<div class="refs-section">
      <div class="refs-title">References</div>
      ${t.refs.map(o=>`
        <span class="ref-item" data-ref-id="${o.id}" data-ref-type="${o.type}">
          ${mt(o.type)} ${p(o.label||o.id)}
        </span>
      `).join("")}
    </div>`),i.innerHTML=r,H(i)}function wi(e,t,n){const i=e?.querySelector(".panel-content");if(!i)return;const s=t?.text||"",a=n?.text||"";let r=`<div class="text">${Q(s)}</div>`;a&&(r+=`<div class="text system-note">${Q(a)}</div>`),t?.refs?.length&&(r+=`<div class="refs-section">
      <div class="refs-title">References</div>
      ${t.refs.map(o=>`
        <span class="ref-item" data-ref-id="${o.id}" data-ref-type="${o.type}">
          ${mt(o.type)} ${p(o.label||o.id)}
        </span>
      `).join("")}
    </div>`),i.innerHTML=r,H(i)}function bi(e,t){const n=e?.querySelector(".panel-content");if(!n)return;const i=gi(t),s=C||Ve(t)[0]||"",{localResults:a}=s?nn(s):{localResults:[]},r=a.length,o=Ge.length===0?"Catalog empty or missing.":`Matches: ${r}`;n.innerHTML=`
    <div class="query-tags-block">
      ${i||""}
    </div>
    <div class="query-status">${p(o)}</div>
  `,H(n)}function H(e){e.querySelectorAll(".pointer-tag").forEach(t=>{const n=t.dataset.tag;n&&(C===n?t.classList.add("active"):t.classList.remove("active"),t.addEventListener("click",i=>{i.preventDefault(),Kt(n,"text")}))})}function Kt(e,t="text"){C=e,ae=!0,Pe=null;const n=sn(),i=e?[{type:"projection",value:e,source:t}]:[];Ce=n?[{type:"owner",value:n,source:"node",locked:!0},...i]:i,ie(document.getElementById("service-panel"),d?.service),en(),me()}function Zt(){C=null,ae=!1,Pe=null,Ce=[],ie(document.getElementById("service-panel"),d?.service),en(),me()}function $i(e){if(!e)return null;const t=e.id||e.external_id||"";return!t||t.startsWith("http")||!t.includes(":")?null:t}function en(){document.querySelectorAll(".pointer-tag").forEach(e=>{const t=e.dataset.tag;t&&e.classList.toggle("active",t===C)})}function tn(e){Pe=e;const t=sn(),n=t?[{type:"owner",value:t,source:"node",locked:!0}]:[],i=C?[{type:"projection",value:C}]:[],s=$i(e);Ce=s?[...n,...i,{type:"entity",value:s,source:"card"}]:[...n,...i],ie(document.getElementById("service-panel"),d?.service),me()}function nn(e){const t=Ce.find(s=>s.type==="owner")?.value||null,n=Ge.filter(s=>!(!Array.isArray(s.pointer_tags)||!s.pointer_tags.includes(e)||t&&!s.pointer_tags.includes(t))),i=xi(e);return{localResults:n,externalLinks:i}}function sn(){return d?.type==="character"?`owner:${d.id}`:null}function me(){const e=document.getElementById("context-strip");if(!e)return;const t=Ei(),i=Si(Ce).map(a=>{const r=`${a.type}:${a.value}`,o=a.type!=="owner";return`
      <span class="context-pill context-pill--${a.type}" data-context-type="${a.type}" data-context-value="${a.value}">
        <span class="context-label">${p(r)}</span>
        ${a.source?`<span class="context-source">${p(a.source)}</span>`:""}
        ${a.locked?'<span class="context-lock">üîí</span>':""}
        ${o?'<button class="context-close" data-action="remove-context">√ó</button>':""}
      </span>`}).join(""),s=a=>t===a?" legend-active":"";e.innerHTML=`
    <div class="context-strip-row">
      <div class="context-response">${p(t)}</div>
      <div class="context-pills">${i||'<span class="context-empty">no context</span>'}</div>
      <div class="context-legend">
        <span class="legend-item legend-results${s("Results")}">Results</span>
        <span class="legend-item legend-actions${s("Actions")}">Actions</span>
        <span class="legend-item legend-steps${s("Steps")}">Steps</span>
        <span class="legend-item legend-info${s("Info")}">Info</span>
      </div>
    </div>
  `,e.querySelectorAll("[data-action='remove-context']").forEach(a=>{a.addEventListener("click",r=>{r.preventDefault();const o=a.closest(".context-pill");if(!o)return;const c=o.dataset.contextType,l=o.dataset.contextValue;c==="projection"&&l===C?Zt():c==="entity"&&tn(null)})})}function Si(e){const t={owner:0,projection:1,entity:2};return[...e].sort((n,i)=>(t[n.type]??99)-(t[i.type]??99))}function Ei(){return ae&&C?"Results":d?.service?.actions?.length?"Actions":d?.type==="practice"?"Steps":"Info"}function xi(e){const t=Bt.get(e),n=pi(e),i=t?.external_queries?.huggingface||n,s=t?.external_queries?.paperswithcode||n;return{huggingface:i?`https://huggingface.co/models?search=${encodeURIComponent(i)}`:null,paperswithcode:s?`https://paperswithcode.com/search?q=${encodeURIComponent(s)}`:null}}function Li(e){const{localResults:t,externalLinks:n}=nn(e),i={service:[],model:[],method:[],other:[]};t.forEach(f=>{i[f.kind]?i[f.kind].push(f):i.other.push(f)});const s=f=>f.map(h=>{const L=jt.filter(m=>m.item_external_id===h.external_id).map(m=>m.practice_id).join(", "),w=h.external_id?.startsWith("http")?`<a class="query-link" href="${h.external_id}" target="_blank">Open</a>`:"",b=h.id||h.external_id||"";return`
      <div class="query-item" data-item-id="${p(b)}" data-item-kind="${p(h.kind||"")}">
        <div class="query-item-title">${p(h.title||h.display_name||h.external_id||"Item")}</div>
        <div class="query-item-meta">
          <span>${p(h.kind||"item")}</span>
          <span>${p(h.source||"unknown")}</span>
          ${L?`<span class="query-badge">participates: ${p(L)}</span>`:""}
          ${w}
        </div>
      </div>
    `}).join(""),a=(f,h)=>h.length?`
    <div class="query-section">
      <div class="query-section-title">${f}</div>
      ${s(h)}
    </div>
  `:"",r=t.length,o=Ge.length===0?"Catalog empty or missing.":r===0?"No matches for this tag.":`Matches: ${r}`,c=r>0?"Scroll to see results.":"",l=[n.huggingface?`<a class="query-external" href="${n.huggingface}" target="_blank">Open in Hugging Face</a>`:"",n.paperswithcode?`<a class="query-external" href="${n.paperswithcode}" target="_blank">Open in Papers with Code</a>`:""].join(""),S=t.length===0?'<div class="query-empty">No results for this tag.</div>':"",g=Pe?`
      <div class="opportunities">
        <div class="opportunities-title">You can do now</div>
        <div class="opportunity-item">–°–¥–µ–ª–∞—Ç—å –æ–±–∑–æ—Ä —Å–µ—Ä–≤–∏—Å–∞ (${p(Pe.name)}) ‚Äî –ù—ç–π ‚Äî soon</div>
        <div class="opportunity-item">–°–æ–±—Ä–∞—Ç—å —Ç—É—Ç–æ—Ä–∏–∞–ª –ø–∞–π–ø–ª–∞–π–Ω–∞ ‚Äî –†—É–Ω–∞ ‚Äî soon</div>
      </div>
    `:"";return`
    <div class="query-mode">
      <div class="query-header">
        <span class="query-label">Query Mode</span>
        <span class="pointer-tag active" data-tag="${e}">${p(e)}</span>
        <button class="query-reset" data-action="clear-query">√ó</button>
      </div>
      <div class="query-status">${p(o)}</div>
      ${c?`<div class="query-hint">${p(c)}</div>`:""}
      ${a("Services",i.service)}
      ${a("Models",i.model)}
      ${a("Methods",i.method)}
      ${a("Other",i.other)}
      ${l?`<div class="query-links">${l}</div>`:""}
      ${g}
      ${S}
    </div>
  `}function Ii(e){e.querySelectorAll("[data-action='clear-query']").forEach(t=>{t.addEventListener("click",()=>{Zt()})}),e.querySelectorAll(".query-item").forEach(t=>{t.dataset.itemKind==="service"&&t.addEventListener("click",i=>{if(i.target?.closest("a"))return;const s=t.dataset.itemId,a=t.querySelector(".query-item-title")?.textContent||s;tn({id:s,name:a})})}),H(e)}function Re(e,t){const n=e?.querySelector(".panel-content");if(!n)return;let i=`<div class="text">${Q(t?.text||"")}</div>`;t?.refs?.length&&(i+=`<div class="refs-section">
      <div class="refs-title">References</div>
      ${t.refs.map(s=>`
        <span class="ref-item" data-ref-id="${s.id}" data-ref-type="${s.type}">
          ${mt(s.type)} ${p(s.label||s.id)}
        </span>
      `).join("")}
    </div>`),n.innerHTML=i,H(n)}function ie(e,t){const n=e?.querySelector(".panel-content");if(!n)return;if(C&&ae){n.innerHTML=Li(C),Ii(n);return}let i=`<div class="text">${Q(t?.text||"")}</div>`;const s=Array.isArray(t?.actions)?t.actions:[],a=s.filter(o=>o.type==="workbench"),r=s.filter(o=>o.type!=="workbench");a.length&&(i+=`<div class="workbench-section">
      <div class="workbench-title">Workbenches</div>
      ${a.map(o=>`
        <button class="action-button" data-action-type="${o.type}" data-action-id="${o.id||""}">
          ${At(o.type)} ${p(o.label)}
        </button>
      `).join("")}
    </div>`),r.length&&(i+=`<div class="actions-section">
      ${r.map(o=>`
        <button class="action-button" data-action-type="${o.type}" data-action-id="${o.id||""}">
          ${At(o.type)} ${p(o.label)}
        </button>
      `).join("")}
    </div>`),n.innerHTML=i,H(n),n.querySelectorAll(".action-button").forEach(o=>{o.addEventListener("click",()=>{_(),B.resumeIfNeeded(),ki(o.dataset.actionType)})})}function ki(e){switch(e){case"navigate":dt();break;case"restart":G(R.start_node_id);break}}function Ti(){const e=document.getElementById("prev-btn"),t=document.getElementById("next-btn"),n=document.getElementById("step-indicator");e&&(e.disabled=!Jn()),t&&(t.disabled=!Yn()),n&&R&&(n.textContent=`${d?.label||""} (${zt+1}/${R.nodes.length})`)}function p(e){const t=document.createElement("div");return t.textContent=e||"",t.innerHTML}function mt(e){return""}function At(e){return""}function ue(e){document.body.classList.remove("focus-story","focus-system","focus-service"),e==="story-panel"&&document.body.classList.add("focus-story"),e==="system-panel"&&document.body.classList.add("focus-system"),e==="service-panel"&&document.body.classList.add("focus-service")}function Pi(){const e=document.createElement("div");e.id="header-trigger",document.body.appendChild(e);const t=document.createElement("div");t.id="header-bar",t.innerHTML=`
    <div class="header-left">
      <div class="header-logo-circle" style="background-image: url('${Be.LOGOS}/brands/logo-ii.png')"></div>
      <span class="header-logo">–í–æ–≤–∞ –∏ –ü–µ—Ç—Ä–æ–≤–∞</span>
    </div>
    <div class="header-center">
      <div class="social-links">
        <span class="social-link" title="Telegram">TG</span>
        <span class="social-link" title="GitHub">GH</span>
        <span class="social-link" title="YouTube">YT</span>
      </div>
    </div>
    <div class="header-right">
      <button class="header-btn" title="Coming soon">Donate</button>
      <button class="header-btn" title="Coming soon">Sign in</button>
      <button class="header-btn" title="Coming soon">RU</button>
    </div>
  `,document.body.appendChild(t);const n=document.createElement("div");n.id="graph",document.body.appendChild(n);const i=document.createElement("div");i.id="panels-container",i.innerHTML=`
    <div id="story-panel" class="panel-3s">
      <div class="panel-content"></div>
    </div>
    <div class="graph-spacer"></div>
    <div id="right-column">
      <div id="context-strip" class="context-strip"></div>
      <div id="system-panel" class="panel-3s">
        <div class="panel-content"></div>
      </div>
      <div id="service-panel" class="panel-3s">
        <div class="panel-content"></div>
      </div>
    </div>
  `,document.body.appendChild(i);const s=document.getElementById("story-panel"),a=document.getElementById("system-panel"),r=document.getElementById("service-panel");ue("story-panel"),a?.addEventListener("mouseenter",()=>ue("system-panel")),r?.addEventListener("mouseenter",()=>ue("service-panel")),s?.addEventListener("mouseenter",()=>ue("story-panel")),a?.addEventListener("mouseleave",()=>ue("story-panel")),r?.addEventListener("mouseleave",()=>ue("story-panel"));const o=document.createElement("div");o.id="nav-bar",o.innerHTML=`
    <button id="prev-btn" class="nav-button">‚Üê Prev</button>
    <span id="step-indicator">Loading...</span>
    <button id="next-btn" class="nav-button">Next ‚Üí</button>
    <div id="view-switcher" class="view-switcher">
      <button class="nav-button view-button" data-view="knowledge">Knowledge</button>
      <button class="nav-button view-button" data-view="system">System</button>
      <button class="nav-button view-button" data-view="all">All</button>
    </div>
    <button id="reload-btn" class="nav-button reload-button" title="Reload route from contracts">üîÑ</button>
    <span id="graph-stats" class="graph-stats"></span>
  `,document.body.appendChild(o),document.getElementById("prev-btn")?.addEventListener("click",()=>{_(),B.resumeIfNeeded(),Ft()}),document.getElementById("next-btn")?.addEventListener("click",()=>{_(),B.resumeIfNeeded(),dt()}),document.getElementById("reload-btn")?.addEventListener("click",()=>{_(),Fn()}),document.querySelectorAll(".view-button").forEach(c=>{c.addEventListener("click",()=>{if(ve!=="canon")return;const l=c.dataset.view||"all";on(l)})})}function an(){ze=performance.now(),Wn(ze),On(ze),O.update(),requestAnimationFrame(an)}u.onEngineTick(()=>{B.tick(u.graphData().nodes)});window.addEventListener("resize",()=>{u.width(window.innerWidth).height(window.innerHeight)});document.addEventListener("keydown",e=>{_(),e.key==="ArrowLeft"&&Ft(),e.key==="ArrowRight"&&dt()});["wheel","pointerdown","touchstart"].forEach(e=>{window.addEventListener(e,()=>{_(),B.resumeIfNeeded()},{passive:!0})});u.width(window.innerWidth).height(window.innerHeight);an();const Ye=new URLSearchParams(window.location.search),Nt=Ye.get("route"),Ci=Ye.get("source"),Mi=Ye.get("graphUrl"),Ai=Ye.get("view");ve=Ci||"canon";Dt=Mi||k.defaultGraphUrl;se=Ai||"all";Hn();Gn();ve==="demo"&&Nt?He(Nt):ve==="demo"?He(k.defaultRoute):Vt();on(se);function on(e){if(se=e||"all",Ni(),ve!=="canon")return;nt&&lt(Gt(nt,se));const t=new URLSearchParams(window.location.search);t.set("view",se),history.replaceState(null,"",`${window.location.pathname}?${t}`)}function Ni(){document.querySelectorAll(".view-button").forEach(e=>{e.dataset.view===se?e.classList.add("active"):e.classList.remove("active")})}
