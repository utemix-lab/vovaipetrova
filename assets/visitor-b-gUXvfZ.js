import{S as qt,_ as fn,A as zt,D as gn,L as hn,V as fe,M as Pe,B as tt,F as $t,a as qe,b as mn,c as nt,d as it,G as Dt,e as J,C as xe,Q as St,f as vn,P as yn,W as wn,I as Et,g as xt,E as bn,h as $n,R as Sn}from"./3d-force-graph-Qkr9Kv2e.js";import{V as Z}from"./config-C8ziI3q8.js";const Ze="/vovaipetrova/",En=Ze.endsWith("/")?Ze.slice(0,-1):Ze,V=e=>`${En}${e.startsWith("/")?"":"/"}${e}`,Oe={DATA_ROOT:V("/data"),GRAPH_ROOT:V("/data/graph"),ASSETS_ROOT:V("/data/assets"),UNIVERSE_JSON:V("/data/graph/universe.json"),EDITOR_HTML:V("/data/graph/editor.html"),LOGOS:V("/data/assets/logos"),BACKGROUNDS:V("/data/assets/backgrounds"),AVATARS:V("/data/assets/avatars"),FLAGS:V("/data/assets/flags"),EXPORTS:V("/data/exports")},k={contractsPath:Oe.DATA_ROOT,defaultRoute:"demo/visitor.demo.route.json",defaultGraphUrl:Oe.UNIVERSE_JSON},xn=`${Oe.AVATARS}/author-plug.png`,ee=Z.node.minRadius,Ln=.07,In=.0016,kn=.08,Tn=.0013,Pn=.18,Cn=2200,Mn={holdMs:420},O={...Z.colors,nodeSelected:"#fbbf24",nodeStart:"#22d3ee",linkDefault:"#6b7280"},ge={type:"concept",visibility:"public",status:"expandable",semantics:{role:"content",abstraction:"medium"},rag:{index:!0,priority:.5}},An={knowledge:new Set(["domain","concept","character"]),system:new Set(["root","hub","module","spec","process","policy"]),all:null};document.body.classList.add("visitor-mode");Ai();const Rn=document.getElementById("graph");let N=null,d=null,Bt=0,st=null,ae="all",ye="canon",Ot=k.defaultGraphUrl,$=new Map,Q=new Map,K=null,Lt=null,jt=new Map,Fe=[],Wt=[],Ee=null,Me=[],C=null,oe=!1,Ce=null;const It={"domain-ai":{id:"practice-direction",label:"–†–µ–∂–∏—Å—Å—É—Ä–∞"}};let U=null,rt=!1,he=new Set,te=null,Le=null,Ie=null,P=null,je=new Map,z=null,ze=null,ct=null,De=0,Ht=0,kt=0,lt=!1;const ie=new Set,re=new Set,Nn=new qt(1,48,48),ke=new Map,we=new Map,dt=new Map,We=new Map,Be=new Map,u=fn()(Rn).backgroundColor(Z.colors.background).showNavInfo(!1).nodeRelSize(ee).linkOpacity(.35).linkWidth(.6).linkDirectionalParticles(0);u.d3Force("link").distance(e=>On(e));u.d3VelocityDecay(.08);u.d3AlphaDecay(.008);u.scene().add(new zt(16777215,.7));const Gt=new gn(16777215,.8);Gt.position.set(40,60,120);u.scene().add(Gt);const Vt=u.camera();Vt.fov=Z.camera.fov;Vt.updateProjectionMatrix();const W=u.controls();W.enableDamping=!0;W.dampingFactor=.08;W.rotateSpeed=.6;W.zoomSpeed=.8;W.autoRotate=!0;W.autoRotateSpeed=Pn;W.minDistance=80;W.maxDistance=600;function D(e){return e&&typeof e=="object"?e.id:e}function Ue(e){let t=0;for(let n=0;n<e.length;n+=1)t=t*31+e.charCodeAt(n)|0;return Math.abs(t)}let Te=null;function ce(e){return Te&&e.id===Te||d&&e.id===d.id?O.nodeSelected:e.isStart?O.nodeStart:rt&&he.has(e.id)?O.nodeSelected:O.nodeDefault}function He(e){return e.visualRadius&&Number.isFinite(e.visualRadius)?e.visualRadius:e.size&&Number.isFinite(e.size)?Math.min(Z.node.maxRadius,Math.max(Z.node.minRadius,e.size)):e.type==="hub"||e.type==="root"?ee*10:ee}function Qe(e){const t=String(e).toLowerCase();if(ke.has(t))return ke.get(t);const n=new xe(e),i=new it({color:n.clone().multiplyScalar(.6),emissive:n.clone(),emissiveIntensity:.2,roughness:.3,metalness:0,transparent:!1,opacity:1});return i.onBeforeCompile=s=>{s.uniforms.rimColor={value:n},s.uniforms.rimPower={value:2.2},s.uniforms.rimStrength={value:.9},s.fragmentShader=s.fragmentShader.replace("#include <output_fragment>",["float rim = pow(1.0 - max(dot(normalize(vNormal), normalize(vViewPosition)), 0.0), rimPower);","vec3 rimLight = rimColor * rim * rimStrength;","gl_FragColor = vec4(outgoingLight + rimLight, diffuseColor.a);"].join(`
`))},ke.set(t,i),i}function _n(e){const t=new Pe(Nn,Qe(ce(e))),n=He(e);if(t.scale.setScalar(n),we.set(e.id,t),dt.set(e.id,n),!We.has(e.id)){const i=Ue(String(e.id))%1e3;We.set(e.id,i/1e3*Math.PI*2)}return t}function qn(){const e=[new fe(1,0),new fe(.6,.18),new fe(.3,.52),new fe(.08,.9),new fe(0,1)],t=new hn(e,28);return t.computeVertexNormals(),t}const Tt=qn();function zn(e){const t=new tt;t.setAttribute("position",new $t([0,0,0,0,0,0,0,0,0],3)),t.setAttribute("color",new $t([1,1,1,1,1,1,1,1,1],3));const n=new qe({vertexColors:!0,transparent:!0,opacity:.45,blending:mn}),i=new nt(t,n),s=new it({color:16777215,transparent:!1,opacity:1,depthWrite:!0}),a=new it({color:16777215,transparent:!1,opacity:1,depthWrite:!0}),r=new Pe(Tt,s),o=new Pe(Tt,a),c=new Dt;return c.add(i),c.add(r),c.add(o),c.userData={line:i,nozzleA:r,nozzleB:o},c}function Dn(e,t,n){const{line:i,nozzleA:s,nozzleB:a}=e.userData,r=new J(t.start.x,t.start.y,t.start.z),o=new J(t.end.x,t.end.y,t.end.z),c=o.clone().sub(r),l=Math.max(1e-4,c.length()),S=c.clone().normalize(),f=1+Math.sin(De*Tn+Bn(n))*kn,h=$.get(D(n.source)),A=$.get(D(n.target)),L=re.has(n);let w,b,m;if(L){const ue=new xe(O.nodeSelected);w=ue,b=ue,m=ue}else w=new xe(h?ce(h):O.linkDefault),b=new xe(A?ce(A):O.linkDefault),m=new xe(O.linkDefault);const y=i.geometry.getAttribute("color");y.array[0]=w.r,y.array[1]=w.g,y.array[2]=w.b,y.array[3]=m.r,y.array[4]=m.g,y.array[5]=m.b,y.array[6]=b.r,y.array[7]=b.g,y.array[8]=b.b,y.needsUpdate=!0,i.material.opacity=L?.9:.4;const v=h?He(h):ee,E=A?He(A):ee;let x=Math.min(l*.45,v*2)*f,I=Math.min(l*.45,E*2)*f;const be=v*.35,$e=E*.35,Se=Math.max(.001,l-v-E),Ae=x+I;if(Ae>Se*.9){const ue=Se*.9/Ae;x*=ue,I*=ue}const ln=v*.45,dn=E*.45,wt=r.clone().add(S.clone().multiplyScalar(v-ln)),bt=o.clone().add(S.clone().multiplyScalar(-(E-dn))),Re=wt.clone().add(S.clone().multiplyScalar(x)),Ne=bt.clone().add(S.clone().multiplyScalar(-I)),Ke=Re.clone().add(Ne).multiplyScalar(.5),G=i.geometry.getAttribute("position");G.array[0]=Re.x,G.array[1]=Re.y,G.array[2]=Re.z,G.array[3]=Ke.x,G.array[4]=Ke.y,G.array[5]=Ke.z,G.array[6]=Ne.x,G.array[7]=Ne.y,G.array[8]=Ne.z,G.needsUpdate=!0,s.visible=!0,a.visible=!0;const un=new St().setFromUnitVectors(new J(0,1,0),S),pn=new St().setFromUnitVectors(new J(0,1,0),S.clone().multiplyScalar(-1));s.quaternion.copy(un),a.quaternion.copy(pn),s.position.copy(wt),a.position.copy(bt),s.scale.set(be,x,be),a.scale.set($e,I,$e),s.material.color.copy(w),a.material.color.copy(b)}function Bn(e){const t=e.id||`${D(e.source)}-${D(e.target)}`;if(Be.has(t))return Be.get(t);const i=Ue(String(t))%1e3/1e3*Math.PI*2;return Be.set(t,i),i}function On(e){const t=Z.link.baseLength,n=Z.link.lengthVariance,s=Ue(String(e.id||`${D(e.source)}-${D(e.target)}`))%1e3/1e3;return t+(s-.5)*n*2}function jn(e){const t={...ge.semantics,...e.semantics||{}},n={...ge.rag,...e.rag||{}};return{...e,type:e.type||ge.type,visibility:e.visibility||ge.visibility,status:e.status||ge.status,semantics:t,rag:n}}function Wn(e,t,n){if(!n||n==="all")return{nodes:e,edges:t};const i=An[n];if(!i)return{nodes:e,edges:t};const s=new Set,a=e.filter(o=>{const c=o.type||ge.type,l=i.has(c);return l&&s.add(o.id),l}),r=t.filter(o=>{const c=typeof o.source=="object"?o.source.id:o.source,l=typeof o.target=="object"?o.target.id:o.target;return s.has(c)&&s.has(l)});return{nodes:a,edges:r}}u.nodeLabel(e=>e.label||e.id);u.nodeColor(e=>ce(e));u.nodeThreeObject(e=>_n(e));u.nodeThreeObjectExtend(!1);u.nodeVal(e=>He(e)/ee);u.linkThreeObject(e=>zn());u.linkPositionUpdate((e,t,n)=>Dn(e,t,n));u.linkColor(e=>re.has(e)?O.highlight:O.linkDefault);u.linkWidth(e=>re.has(e)?1.6:.6);const B=(()=>{let e=null,t=null,n=null,i=null,s=null,a=null,r=!1;const o=80,c=.25,l=200,S=800,g=.92;let f=0,h=l,A=0,L=l;function w(){if(r)return;e=new AudioContext,t=e.createOscillator(),t.type="sine",t.frequency.value=o,n=e.createOscillator(),n.type="sine",n.frequency.value=o*2,i=e.createOscillator(),i.type="triangle",i.frequency.value=o*1.5;const v=e.createGain();v.gain.value=1;const E=e.createGain();E.gain.value=1,t.connect(E),E.connect(v);const x=e.createGain();x.gain.value=.3,n.connect(x),x.connect(v);const I=e.createGain();I.gain.value=.15,i.connect(I),I.connect(v),a=e.createBiquadFilter(),a.type="lowpass",a.frequency.value=l,a.Q.value=2,s=e.createGain(),s.gain.value=0,v.connect(a),a.connect(s),s.connect(e.destination),t.start(),n.start(),i.start(),r=!0,console.log("[MotionSound] Initialized")}async function b(){r||w(),e&&e.state==="suspended"&&await e.resume()}function m(v){if(!v||v.length===0)return 0;let E=0,x=0;return v.forEach(I=>{const be=I.vx||0,$e=I.vy||0,Se=I.vz||0,Ae=Math.sqrt(be*be+$e*$e+Se*Se);E+=Ae,x++}),x>0?E/x:0}function y(v){if(!(!r||!e||e.state!=="running")){if(lt)A=0,L=l;else{const E=m(v),x=Math.min(1,E/2.5);A=x*c,L=l+x*(S-l);const I=1+x*.15;t&&(t.frequency.value=o*I),n&&(n.frequency.value=o*2*I),i&&(i.frequency.value=o*1.5*I)}f=f*g+A*(1-g),h=h*g+L*(1-g),s&&(s.gain.value=f),a&&(a.frequency.value=h)}}return{resumeIfNeeded:b,tick:y}})();function Hn(e){$=new Map(e.nodes.map(t=>[t.id,t])),Q=new Map,e.links.forEach(t=>{const n=D(t.source),i=D(t.target);Q.has(n)||Q.set(n,new Set),Q.has(i)||Q.set(i,new Set),Q.get(n).add(i),Q.get(i).add(n)})}function M(e){ie.clear(),re.clear(),e&&(ie.add(e),u.graphData().links.forEach(n=>{const i=D(n.source),s=D(n.target);if(i===e.id||s===e.id){re.add(n);const a=i===e.id?s:i,r=$.get(a);r&&ie.add(r)}}))}let ne=null;u.onNodeHover(e=>{ne&&ne!==e?.id&&(R(ne,!1),me(ne,!1),At(ne,!1),ne=null),e!==U&&(U=e||null,M(U),u.refresh(),U&&(R(U.id,!0),me(U.id,!0),At(U.id,!0),ne=U.id))});u.onNodeClick(e=>{q(),B.resumeIfNeeded(),F(e.id)});u.onNodeDrag(e=>{q(),lt=!0,e.fx=e.x,e.fy=e.y,e.fz=e.z});u.onNodeDragEnd(e=>{lt=!1,e.fx=null,e.fy=null,e.fz=null,B.resumeIfNeeded()});function Gn(e){const t=e*In;we.forEach((n,i)=>{const s=dt.get(i);if(!s)return;const a=We.get(i)||0,r=1+Math.sin(t+a)*Ln;n.scale.setScalar(s*r)})}function Vn(e){const t=e-Ht>Cn;W.autoRotate=t,t&&(kt+=25e-5,u.scene().rotation.y=kt)}function q(){Ht=performance.now(),W.autoRotate=!1}async function Ge(e){const t=`${k.contractsPath}/routes/${e}`;try{const n=await fetch(t+"?t="+Date.now());if(!n.ok)throw new Error(`Failed to load: ${t}`);const i=await n.json();ut(i)}catch(n){console.error("[Visitor] Failed to load route:",n)}}async function Ft(){const e=Jn(Ot);try{const t=await fetch(Xe(e));if(!t.ok)throw new Error(`Failed to load: ${e}`);const n=await t.json();st=n;const i=Ut(n,ae);ut(i),console.log("[Visitor] Loaded Universe Graph with",i.nodes.length,"nodes")}catch(t){console.error("[Visitor] Failed to load Universe Graph:",t),Ge(k.defaultRoute)}}async function Fn(){const e=`${k.contractsPath}/ui/widgets/domains.json`;try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}`);K=await t.json(),console.log("[Visitor] Loaded domain widgets:",K.widgets?.length)}catch(t){console.warn("[Visitor] Domain widgets not available:",t.message),K=null}}function Un(e){return(e||"").split(`
`).map(t=>t.trim()).filter(t=>t.length>0).map(t=>{try{return JSON.parse(t)}catch{return console.warn("[Visitor] Failed to parse JSONL line:",t),null}}).filter(Boolean)}function Pt(e,t){const i=((e||"").split("/").pop()||"").replace(/\.jsonl?$/i,"");return t==="catalog"&&i.endsWith("_catalog")?i.slice(0,-8):t==="registry"&&i.endsWith("_registry")?i.slice(0,-9):i}async function Ct(e){const t=`${k.contractsPath}/${e}`,n=await fetch(Xe(t));if(!n.ok)throw new Error(`HTTP ${n.status}`);return n.json()}async function et(e){const t=`${k.contractsPath}/${e}`,n=await fetch(Xe(t));if(!n.ok)throw new Error(`HTTP ${n.status}`);const i=await n.text();return Un(i)}function Mt(e){Lt=e.registries.pointer_tags||null,jt=new Map((Lt?.tags||[]).map(t=>[t.tag,t])),Fe=e.catalogs.ai||[],Wt=e.catalogs.practice_participation||[]}async function Qn(){if(Ee)return Ee;const e=`${k.contractsPath}/manifests/assets.manifest.json`;try{const t=await fetch(Xe(e));if(!t.ok)throw new Error(`HTTP ${t.status}`);const i=(await t.json()).exports||{},s=i.catalogs||[],a=i.registries||[],r={catalogs:{},registries:{}};return await Promise.all([...s.map(async o=>{const c=Pt(o,"catalog");r.catalogs[c]=await et(o)}),...a.map(async o=>{const c=Pt(o,"registry");r.registries[c]=await Ct(o)})]),Ee=r,Mt(r),console.log("[Visitor] Loaded exports:",Object.keys(r.catalogs).length,"catalogs"),r}catch(t){console.warn("[Visitor] Exports manifest not available:",t.message);const n={catalogs:{},registries:{}};try{n.registries.pointer_tags=await Ct("exports/pointer_tags_registry.json")}catch(i){console.warn("[Visitor] Pointer tags registry not available:",i.message)}try{n.catalogs.ai=await et("exports/ai_catalog.jsonl")}catch(i){console.warn("[Visitor] AI catalog not available:",i.message)}try{n.catalogs.practice_participation=await et("exports/practice_participation.jsonl")}catch(i){console.warn("[Visitor] Practice participation not available:",i.message)}return Ee=n,Mt(n),Ee}}async function Xn(){console.log("[Visitor] Reloading...");const e=document.getElementById("step-indicator");e&&(e.textContent="Reloading..."),ye==="demo"?await Ge(k.defaultRoute):await Ft(),console.log("[Visitor] Reloaded!")}function Ut(e,t){const n=(e.nodes||[]).map(a=>jn(a)),i=(e.edges||[]).map(a=>({...a,type:a.type||"relates"})),s=Wn(n,i,t);return{id:"universe-graph",title:e.meta?.description||"Universe Graph",nodes:s.nodes.map(a=>({...a,label:a.label,position:a.position,story:{text:a.story||"",refs:[]},system:{text:a.system||"",refs:[]},service:Yn(a.service)})),edges:s.edges.map(a=>({id:a.id,source:a.source,target:a.target,type:"NEXT"})),start_node_id:s.nodes[0]?.id||"universe"}}function Yn(e){return e?typeof e=="string"?{text:e,actions:[]}:typeof e=="object"?{text:e.text||"",actions:Array.isArray(e.actions)?e.actions:[]}:{text:String(e),actions:[]}:{text:"",actions:[]}}function Jn(e){return!e.startsWith("http")&&!e.startsWith("/")?`${k.contractsPath}/${e}`:e}function Xe(e){const t=new URL(e,window.location.href);return t.searchParams.set("t",Date.now().toString()),t.toString()}function ut(e){N=e;const t={nodes:e.nodes.map(i=>{const s=Ue(i.id)%100/100*2,a=ee+s,r=i.type==="hub"||i.type==="root"?ee*4:a;return{...i,isStart:i.id===e.start_node_id,visualRadius:r}}),links:e.edges.map(i=>({id:i.id,source:i.source,target:i.target,type:i.type}))};we.clear(),dt.clear(),We.clear(),Be.clear(),ke.clear(),u.graphData(t),Hn(t),Kn(t.nodes.length,t.links.length);const n=e.start_node_id||e.nodes[0]?.id;F(n),setTimeout(()=>{u.zoomToFit(800,150)},200),console.log("[Visitor] Route loaded:",e.title)}function Kn(e,t){const n=document.getElementById("graph-stats");n&&(n.textContent=`${e} nodes | ${t} edges`)}function F(e){const t=$.get(e);!t||!N||(d=t,Bt=N.nodes.findIndex(n=>n.id===e),ke.clear(),we.forEach((n,i)=>{const s=$.get(i);s&&(n.material=Qe(ce(s)))}),ti(),Mi(),M(d),u.refresh())}function pt(){if(!N||!d)return;const e=N.edges.find(t=>t.source===d.id&&t.type==="NEXT");e&&F(e.target)}function Qt(){if(!N||!d)return;const e=N.edges.find(t=>t.target===d.id&&t.type==="NEXT");e&&F(e.source)}function Zn(){return!N||!d?!1:N.edges.some(e=>e.source===d.id&&e.type==="NEXT")}function ei(){return!N||!d?!1:N.edges.some(e=>e.target===d.id&&e.type==="NEXT")}function ti(){if(!d)return;const e=document.getElementById("story-panel"),t=document.getElementById("system-panel"),n=document.getElementById("service-panel"),i=d.service?.text||"",s=Ve(i).length>0,a=d.id==="domain-ai";if(a){const r=Ve(i);(!C||!r.includes(C))&&(C=r[0]||null),C&&(oe=!0)}if(d.id==="domains"&&K?.widgets?.length)li(e,d.story);else if(d.id==="practices")di(e,d.story);else if(d.id==="characters")ui(e,d.story);else if(ii(d)){ni(e,d),_e(t,{text:"–†–∞–±–æ—á–µ–µ –æ–∫–Ω–æ"}),se(n,{text:"–†–∞–±–æ—á–µ–µ –æ–∫–Ω–æ",actions:[]}),ve();return}else if(ai(d)){ri(e,d),_e(t,{text:"–†–∞–±–æ—á–µ–µ –æ–∫–Ω–æ"}),se(n,{text:"–†–∞–±–æ—á–µ–µ –æ–∫–Ω–æ",actions:[]}),ve();return}else si(d)?ci(e,d):fi(d)?pi(e,d.story,d):(e?.querySelector(".panel-content")?.classList.remove("story-compact"),oe&&It[d.id]?$i(e,d.story,It[d.id]):s&&!a?Si(e,d.story,d.system):_e(e,d.story));oe&&s?(Ei(t,i),se(n,{text:""})):(_e(t,d.system),se(n,d.service)),ve()}function ni(e,t){const n=e?.querySelector(".panel-content");if(!n)return;le(),n.classList.remove("story-compact");const i=ft(t),s="–û–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–π –±–ª–æ–∫",a=_(t?.id,"domain"),r=_(t?.id,"practice"),o=_(t?.id,"workbench");let c="";i&&(c+=`
      <div class="node-toc">
        <div class="node-widget node-widget--scope node-widget--root vova-scope-widget" data-node-id="${p(t.id)}" title="${p(t.label||t.id)}">
          <div class="widget-frame">
            ${T(i,"widget")}
          </div>
        </div>
      </div>`),c+=`<div class="text">${p(s)}</div>`,c+='<div class="section-title">–ö–æ–Ω—Ç–∏–Ω–µ–Ω—Ç—ã</div>',c+='<div class="domain-widgets inline-widgets">',c+=a.map(l=>{const S=$.get(l)?.label||l;return`
      <div class="domain-widget highlight-widget widget--lever" data-node-id="${l}" title="${p(S)}">
        <div class="widget-frame">
          ${T(gt(),"domain")}
        </div>
      </div>`}).join(""),c+="</div>",c+='<div class="section-title">–ü—Ä–∞–∫—Ç–∏–∫–∏</div>',c+='<div class="domain-widgets inline-widgets">',c+=r.map(l=>{const S=$.get(l)?.label||l;return`
      <div class="domain-widget highlight-widget widget--lever" data-node-id="${l}" title="${p(S)}">
        <div class="widget-frame">
          ${T(Ye(),"practice")}
        </div>
      </div>`}).join(""),c+="</div>",c+='<div class="section-title">–í–æ—Ä–∫–±–µ–Ω—á–∏</div>',c+='<div class="domain-widgets inline-widgets">',c+=o.map(l=>{const S=$.get(l)?.label||l;return`
      <div class="domain-widget highlight-widget widget--lever${at(l)?" domain-widget--shared":""}" data-node-id="${l}" title="${p(S)}">
        <div class="widget-frame">
          ${T(ot(),"workbench")}
        </div>
      </div>`}).join(""),c+="</div>",n.innerHTML=c,vt(n),yi(n,t),de(n),Y(n)}function ii(e){return e&&e.type==="character"}function si(e){return e&&e.type==="domain"}function ai(e){return e&&e.type==="workbench"}function oi(e){const t=["character-vova","character-vasya"];return[...e].sort((n,i)=>{const s=t.indexOf(n),a=t.indexOf(i);return s!==-1||a!==-1?(s===-1?99:s)-(a===-1?99:a):n.localeCompare(i)})}function at(e){return _(e,"character").length>1}function ri(e,t){const n=e?.querySelector(".panel-content");if(!n)return;le(),n.classList.remove("story-compact");const i=t.label||t.id,s=ot(t.id),a=ht(),r=at(t.id)?" node-widget--shared":"",o=oi(_(t.id,"character")),c=_(t.id,"domain"),l=_(t.id,"practice"),S=_(t.id,"workbench").filter(f=>f!==t.id);let g="";g+=`
    <div class="node-toc">
      <div class="node-toc-row">
        <div class="node-widget node-widget--static node-widget--root${r}" title="${p(i)}">
          <div class="widget-frame">
            ${T(s,"workbench")}
          </div>
        </div>
        ${o.map(f=>{const h=$.get(f)?.label||f;return`
            <div class="node-widget node-widget--static node-widget--root node-widget--lever" title="${p(h)}">
              <div class="widget-frame">
                ${T(a,"character")}
              </div>
            </div>`}).join("")}
      </div>
    </div>`,g+='<div class="text">–û–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–π –±–ª–æ–∫</div>',c.length&&(g+='<div class="section-title">–ö–æ–Ω—Ç–∏–Ω–µ–Ω—Ç—ã</div>',g+='<div class="domain-widgets inline-widgets">',g+=c.map(f=>{const h=$.get(f)?.label||f;return`
        <div class="domain-widget highlight-widget widget--lever" data-node-id="${f}" title="${p(h)}">
        <div class="widget-frame">
          ${T(gt(),"domain")}
        </div>
        </div>`}).join(""),g+="</div>"),l.length&&(g+='<div class="section-title">–ü—Ä–∞–∫—Ç–∏–∫–∏</div>',g+='<div class="domain-widgets inline-widgets">',g+=l.map(f=>{const h=$.get(f)?.label||f;return`
        <div class="domain-widget highlight-widget widget--lever" data-node-id="${f}" title="${p(h)}">
        <div class="widget-frame">
          ${T(Ye(),"practice")}
        </div>
        </div>`}).join(""),g+="</div>"),S.length&&(g+='<div class="section-title">–í–æ—Ä–∫–±–µ–Ω—á–∏</div>',g+='<div class="domain-widgets inline-widgets">',g+=S.map(f=>{const h=$.get(f)?.label||f;return`
        <div class="domain-widget highlight-widget widget--lever${at(f)?" domain-widget--shared":""}" data-node-id="${f}" title="${p(h)}">
        <div class="widget-frame">
          ${T(ot(),"workbench")}
        </div>
        </div>`}).join(""),g+="</div>"),n.innerHTML=g,vt(n),de(n),Y(n)}function ci(e,t){const n=e?.querySelector(".panel-content");if(!n)return;le(),n.classList.remove("story-compact");const i=ft(t),s="–û–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–π –±–ª–æ–∫",a=Zt(t?.id),r=_(t?.id,"character"),o=_(t?.id,"practice");let c="";i&&(c+=`
      <div class="node-toc">
        <div class="node-widget node-widget--static node-widget--root" title="${p(t.label||t.id)}">
          <div class="widget-frame">
            ${T(i,"widget")}
          </div>
        </div>
      </div>`),c+=`<div class="text">${p(s)}</div>`,c+=`<div class="potential-section">
    <div class="potential-title">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª</div>`,r.length&&(c+='<div class="potential-group-title">–ü—Ä–æ–≤–æ–¥–Ω–∏–∫–∏</div>',c+='<div class="potential-buttons">',c+=r.map(l=>{const S=$.get(l)?.label||l;return`
        <div class="domain-widget highlight-widget widget--lever" data-node-id="${l}" title="${p(S)}">
        <div class="widget-frame">
          ${T(ht(),"character")}
        </div>
        </div>`}).join(""),c+="</div>"),o.length&&(c+='<div class="potential-group-title">–ü—Ä–∞–∫—Ç–∏–∫–∏</div>',c+='<div class="potential-buttons">',c+=o.map(l=>{const S=$.get(l)?.label||l;return`
        <div class="domain-widget highlight-widget widget--lever" data-node-id="${l}" title="${p(S)}">
        <div class="widget-frame">
          ${T(Ye(),"practice")}
        </div>
        </div>`}).join(""),c+="</div>"),a&&(c+='<div class="potential-group-title">–î–∞–Ω–Ω—ã–µ</div>',c+=`<div class="potential-tags">
      <span class="pointer-tag" data-tag="${p(a)}">${p(a)}</span>
    </div>`),c+="</div>",n.innerHTML=c,H(n),de(n),Y(n),Y(n),Y(n),Y(n),vt(n),Y(n)}function li(e,t){const n=e?.querySelector(".panel-content");if(!n)return;le(),n.classList.add("story-compact");let i=`<div class="text">${X(t?.text||"")}</div>`;i+='<div id="mini-cube-container"></div>',i+='<div class="domain-widgets domain-grid">';for(const a of K.widgets)i+=`
      <div class="domain-widget widget--lever" data-node-id="${a.nodeId}" title="${a.label}">
        <div class="widget-frame">
          ${T(gt(a.nodeId),"domain")}
        </div>
      </div>`;i+="</div>",n.innerHTML=i,H(n),de(n);const s=document.getElementById("mini-cube-container");s&&mt("cube",s,K.widgets.map(a=>a.nodeId),"domains"),n.querySelectorAll(".domain-widget").forEach(a=>{a.addEventListener("mouseenter",()=>{const r=a.dataset.nodeId,o=$.get(r);R(r,!0),j(r,!0),o&&(M(o),u.refresh())}),a.addEventListener("mouseleave",()=>{const r=a.dataset.nodeId;R(r,!1),j(r,!1),M(null),u.refresh()}),a.addEventListener("click",()=>{q(),B.resumeIfNeeded(),F(a.dataset.nodeId)})})}function di(e,t){const n=e?.querySelector(".panel-content");if(!n)return;le(),n.classList.add("story-compact");const i=[...$.values()].filter(r=>r.type==="practice");let s=`<div class="text">${X(t?.text||"")}</div>`;s+='<div id="mini-cube-container"></div>',s+='<div class="domain-widgets practice-grid">';for(const r of i)s+=`
      <div class="domain-widget widget--lever" data-node-id="${r.id}" title="${r.label}">
        <div class="widget-frame">
          ${T(Ye(r.id),"practice")}
        </div>
      </div>`;s+="</div>",n.innerHTML=s,H(n),de(n);const a=document.getElementById("mini-cube-container");a&&mt("icosa",a,i.map(r=>r.id),"practices"),n.querySelectorAll(".domain-widget").forEach(r=>{r.addEventListener("mouseenter",()=>{const o=r.dataset.nodeId,c=$.get(o);R(o,!0),j(o,!0),c&&(M(c),u.refresh())}),r.addEventListener("mouseleave",()=>{const o=r.dataset.nodeId;R(o,!1),j(o,!1),M(null),u.refresh()}),r.addEventListener("click",()=>{q(),B.resumeIfNeeded(),F(r.dataset.nodeId)})})}function ui(e,t){const n=e?.querySelector(".panel-content");if(!n)return;le(),n.classList.add("story-compact");const i=[...$.values()].filter(r=>r.type==="character");let s=`<div class="text">${X(t?.text||"")}</div>`;s+='<div id="mini-cube-container"></div>',s+='<div class="domain-widgets character-grid">';for(const r of i)s+=`
      <div class="domain-widget widget--lever" data-node-id="${r.id}" title="${r.label}">
        <div class="widget-frame">
          ${T(ht(),"character")}
        </div>
      </div>`;s+="</div>",n.innerHTML=s,H(n),de(n);const a=document.getElementById("mini-cube-container");a&&mt("icosa",a,i.map(r=>r.id),"characters"),n.querySelectorAll(".domain-widget").forEach(r=>{r.addEventListener("mouseenter",()=>{const o=r.dataset.nodeId,c=$.get(o);R(o,!0),j(o,!0),c&&(M(c),u.refresh())}),r.addEventListener("mouseleave",()=>{const o=r.dataset.nodeId;R(o,!1),j(o,!1),M(null),u.refresh()}),r.addEventListener("click",()=>{q(),B.resumeIfNeeded(),F(r.dataset.nodeId)})})}function pi(e,t,n){const i=e?.querySelector(".panel-content");if(!i)return;le(),i.classList.remove("story-compact");const s=ft(n);let a="";s&&(a+=`
      <div class="node-toc">
        <div class="node-widget node-widget--static node-widget--root" title="${p(n.label||n.id)}">
          <div class="widget-frame">
            ${T(s,"widget")}
          </div>
        </div>
      </div>`),a+=`<div class="text">${X(t?.text||"")}</div>`,i.innerHTML=a,H(i),de(i),Y(i)}function fi(e){return e&&["domain","practice","character","workbench"].includes(e.type)}function ft(e){return e?e.type==="domain"?K?.widgets?.length&&!K.widgets.some(n=>n.nodeId===e.id)?null:`${k.contractsPath}/assets/icons/domains/plug.png`:e.type==="practice"?`${k.contractsPath}/assets/practices/practice-plug.png`:e.type==="character"?`${k.contractsPath}/assets/avatars/characters/character-plug.png`:e.type==="workbench"?`${k.contractsPath}/assets/workbenches/workbench-plug.png`:null:null}function gt(e){return`${k.contractsPath}/assets/icons/domains/plug.png`}function Ye(e){return`${k.contractsPath}/assets/practices/practice-plug.png`}function ht(){return`${k.contractsPath}/assets/avatars/characters/character-plug.png`}function ot(e){return`${k.contractsPath}/assets/workbenches/workbench-plug.png`}function T(e,t="icon"){const n=p(t);return`<img src="${e}" data-default-src="${e}" data-hover-src="${xn}" alt="${n}" />`}function R(e,t){const n=$.get(e);if(!n)return;t?Te=e:Te===e&&(Te=null);const i=we.get(e);i&&(i.material=Qe(ce(n)))}function me(e,t){const n=document.querySelector(`.domain-widget[data-node-id="${e}"]`);n&&(t?n.classList.add("widget-highlighted"):n.classList.remove("widget-highlighted"))}function mt(e,t,n,i){if(!n||n.length===0)return;ct=i;const s=220,a=s,r=s;Le=new vn,Ie=new yn(50,a/r,.1,100),Ie.position.z=4,P=new wn({alpha:!0,antialias:!0}),P.setSize(a,r),P.setPixelRatio(Math.min(window.devicePixelRatio,2)),t.appendChild(P.domElement),z=new Dt,Le.add(z);let o=[];if(e==="cube")o=[[-1,-1,-1],[1,-1,-1],[1,1,-1],[-1,1,-1],[-1,-1,1],[1,-1,1],[1,1,1],[-1,1,1]].map(b=>b.map(m=>m*.85));else{const b=new Et(1).getAttribute("position").array,m=[];for(let v=0;v<b.length;v+=3){const E=[b[v],b[v+1],b[v+2]],x=E.map(I=>I.toFixed(3)).join(",");if(m.find(I=>I.key===x)||m.push({key:x,v:E}),m.length>=12)break}const y=1.275;o=m.map(v=>v.v.map(E=>E*y))}const c=new qt(.12,16,16),l=new xt({color:7041664});n.slice(0,o.length).forEach((w,b)=>{const m=new Pe(c,l.clone());m.position.set(...o[b]),m.userData.nodeId=w,z.add(m),je.set(w,m)});const g=new xt({color:10265519}),f=new Pe(c,g);if(f.position.set(0,0,0),f.userData.nodeId=i,z.add(f),je.set(i,f),e==="cube"){const w=[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]],b=new qe({color:4937059,opacity:.5,transparent:!0});w.forEach(([m,y])=>{if(!o[m]||!o[y])return;const v=new tt().setFromPoints([new J(...o[m]),new J(...o[y])]),E=new nt(v,b);z.add(E)})}else{const w=new Et(1.275),b=new bn(w),m=new qe({color:4937059,opacity:.45,transparent:!0}),y=new $n(b,m);z.add(y)}if(e==="cube"){const w=new qe({color:3621201,opacity:.3,transparent:!0});o.forEach(b=>{const m=new tt().setFromPoints([new J(0,0,0),new J(...b)]),y=new nt(m,w);z.add(y)})}Le.add(new zt(16777215,.8));const h=new Sn,A=new fe;let L=null;P.domElement.addEventListener("mousemove",w=>{const b=P.domElement.getBoundingClientRect();A.x=(w.clientX-b.left)/b.width*2-1,A.y=-((w.clientY-b.top)/b.height)*2+1,h.setFromCamera(A,Ie);const m=h.intersectObjects(z.children.filter(y=>y.isMesh));if(m.length>0){const y=m[0].object;if(L!==y){if(L){const x=L.userData.nodeId;j(x,!1),R(x,!1),me(x,!1),M(null),u.refresh()}L=y;const v=y.userData.nodeId;j(v,!0),R(v,!0),me(v,!0);const E=$.get(v);E&&(M(E),u.refresh())}}else if(L){const y=L.userData.nodeId;j(y,!1),R(y,!1),me(y,!1),M(null),u.refresh(),L=null}}),P.domElement.addEventListener("click",()=>{if(L){const w=L.userData.nodeId;q(),B.resumeIfNeeded(),F(w)}}),P.domElement.addEventListener("mouseleave",()=>{if(L){const w=L.userData.nodeId;j(w,!1),R(w,!1),me(w,!1),M(null),u.refresh(),L=null}}),Xt()}function j(e,t){const n=je.get(e);if(n)if(t)n.material.color.setHex(16498468),n.scale.setScalar(1.5);else{const i=e===ct;n.material.color.setHex(i?10265519:7041664),n.scale.setScalar(1)}}function Xt(){P&&(ze=requestAnimationFrame(Xt),z&&(z.rotation.y+=.003,z.rotation.x=Math.sin(Date.now()*3e-4)*.1),P.render(Le,Ie))}function le(){ze&&(cancelAnimationFrame(ze),ze=null),P&&(P.dispose(),P.domElement.remove(),P=null),Le=null,Ie=null,z=null,je.clear(),ct=null}function At(e,t){P&&j(e,t)}const Yt=/\b(?:cap|method|arch|provider|domain|model|country|practice):[a-z0-9_:-]+\b/gi;function gi(e){const[t,...n]=e.split(":");return{prefix:(t||"").toLowerCase(),key:(n.join(":")||"").toLowerCase()}}function hi(e){const{key:t}=gi(e);return t.replace(/[_-]+/g," ").trim()}function mi(e){let t="",n=0;return e.replace(Yt,(i,s)=>{const a=e.slice(n,s);return t+=p(a),t+=`<span class="pointer-tag" data-tag="${i}">${p(i)}</span>`,n=s+i.length,i}),t+=p(e.slice(n)),t}function X(e){return(e||"").split(`
`).map(n=>mi(n)).join("<br>")}function Ve(e){return(e||"").match(Yt)||[]}function vi(e){return Ve(e).map(n=>`<span class="pointer-tag" data-tag="${n}">${p(n)}</span>`).join(" ")}function vt(e){e.querySelectorAll(".highlight-widget").forEach(t=>{t.addEventListener("mouseenter",()=>{const n=t.dataset.nodeId,i=$.get(n);R(n,!0),i&&(M(i),u.refresh())}),t.addEventListener("mouseleave",()=>{const n=t.dataset.nodeId;R(n,!1),M(null),u.refresh()}),t.addEventListener("click",n=>{n.preventDefault();const i=t.dataset.nodeId,s=$.get(i);if(s)if(s.type==="domain"){const a=Zt(s.id);a&&en(a,"widget")}else s.type==="workbench"&&(q(),B.resumeIfNeeded(),F(s.id))})})}function yi(e,t){const n=e.querySelector(".vova-scope-widget");if(!n||!t)return;const i=new Set([t.id,..._(t.id,"domain"),..._(t.id,"practice"),..._(t.id,"workbench")]);n.addEventListener("mouseenter",()=>{n.classList.add("scope-active"),Rt(e,!0),wi(i)}),n.addEventListener("mouseleave",()=>{n.classList.remove("scope-active"),Rt(e,!1),bi()})}function Jt(e,t){e&&(t?(te&&te!==e&&Jt(te,!1),te=e,e.classList.add("widget--shifted"),e.style.setProperty("--lever-offset","-10px"),document.body.classList.add("scene-lever-active")):(te===e&&(te=null),e.classList.remove("widget--shifted"),e.style.removeProperty("--lever-offset"),te||document.body.classList.remove("scene-lever-active")))}function de(e){e.querySelectorAll(".widget--lever, .node-widget--lever").forEach(t=>{if(t.dataset.leverBound)return;t.dataset.leverBound="true";let n=null,i=!1,s=0,a=0,r=0,o=null;const c=()=>{n&&(clearTimeout(n),n=null)},l=g=>{if(!i)return;const f=g.clientY-s,h=Math.max(-10,Math.min(0,a+f));r=h,t.style.setProperty("--lever-offset",`${h}px`)},S=()=>{if(i){const g=r<=-6;Jt(t,g)}t.classList.remove("lever-dragging"),i=!1,c(),o!==null&&t.hasPointerCapture(o)&&t.releasePointerCapture(o),o=null};t.addEventListener("pointerdown",g=>{g.button&&g.button!==0||(s=g.clientY,a=t.classList.contains("node-widget--shifted")?-10:0,r=a,o=g.pointerId,t.setPointerCapture&&t.setPointerCapture(o),n=setTimeout(()=>{i=!0,t.classList.add("lever-dragging")},Mn.holdMs))}),t.addEventListener("pointermove",l),t.addEventListener("pointerup",S),t.addEventListener("pointercancel",S),t.addEventListener("click",g=>{(t.classList.contains("node-widget--shifted")||i)&&(g.preventDefault(),g.stopPropagation())})})}function Y(e){e.querySelectorAll(".widget-frame img[data-hover-src]").forEach(t=>{const n=t.closest(".domain-widget, .node-widget");if(!n||n.dataset.swapBound)return;n.dataset.swapBound="true";const i=t.dataset.defaultSrc,s=t.dataset.hoverSrc,a=()=>{s&&(t.src=s,n.classList.add("emblem-swap-active"))},r=()=>{i&&(t.src=i,n.classList.remove("emblem-swap-active"))};n.addEventListener("mouseenter",a),n.addEventListener("mouseleave",r)})}function Rt(e,t){e.querySelectorAll(".highlight-widget").forEach(n=>{n.classList.toggle("widget-scope-highlighted",t)})}function wi(e){rt=!0,he=new Set(e),ie.clear(),re.clear();const t=u.graphData();t.nodes.forEach(n=>{he.has(n.id)&&ie.add(n)}),t.links.forEach(n=>{const i=D(n.source),s=D(n.target);if(he.has(i)||he.has(s)){re.add(n);const a=$.get(i),r=$.get(s);a&&ie.add(a),r&&ie.add(r)}}),Kt(),u.refresh()}function bi(){rt=!1,he=new Set,M(U),Kt(),u.refresh()}function Kt(){we.forEach((e,t)=>{const n=$.get(t);n&&(e.material=Qe(ce(n)))})}function _(e,t){if(!e||!Q.has(e))return[];const n=[];return Q.get(e).forEach(i=>{$.get(i)?.type===t&&n.push(i)}),n}function Zt(e){if(!e||!e.startsWith("domain-"))return null;const t=e.replace("domain-","");return t?`domain:${t}`:null}function $i(e,t,n){const i=e?.querySelector(".panel-content");if(!i)return;const s=t?.text||"",a=`Practice: ${n.label} (${n.id})`;let r=`<div class="practice-hint">${p(a)}</div>`;r+=`<div class="text">${X(s)}</div>`,t?.refs?.length&&(r+=`<div class="refs-section">
      <div class="refs-title">References</div>
      ${t.refs.map(o=>`
        <span class="ref-item" data-ref-id="${o.id}" data-ref-type="${o.type}">
          ${yt(o.type)} ${p(o.label||o.id)}
        </span>
      `).join("")}
    </div>`),i.innerHTML=r,H(i)}function Si(e,t,n){const i=e?.querySelector(".panel-content");if(!i)return;const s=t?.text||"",a=n?.text||"";let r=`<div class="text">${X(s)}</div>`;a&&(r+=`<div class="text system-note">${X(a)}</div>`),t?.refs?.length&&(r+=`<div class="refs-section">
      <div class="refs-title">References</div>
      ${t.refs.map(o=>`
        <span class="ref-item" data-ref-id="${o.id}" data-ref-type="${o.type}">
          ${yt(o.type)} ${p(o.label||o.id)}
        </span>
      `).join("")}
    </div>`),i.innerHTML=r,H(i)}function Ei(e,t){const n=e?.querySelector(".panel-content");if(!n)return;const i=vi(t),s=C||Ve(t)[0]||"",{localResults:a}=s?an(s):{localResults:[]},r=a.length,o=Fe.length===0?"Catalog empty or missing.":`Matches: ${r}`;n.innerHTML=`
    <div class="query-tags-block">
      ${i||""}
    </div>
    <div class="query-status">${p(o)}</div>
  `,H(n)}function H(e){e.querySelectorAll(".pointer-tag").forEach(t=>{const n=t.dataset.tag;n&&(C===n?t.classList.add("active"):t.classList.remove("active"),t.addEventListener("click",i=>{i.preventDefault(),en(n,"text")}))})}function en(e,t="text"){C=e,oe=!0,Ce=null;const n=on(),i=e?[{type:"projection",value:e,source:t}]:[];Me=n?[{type:"owner",value:n,source:"node",locked:!0},...i]:i,se(document.getElementById("service-panel"),d?.service),nn(),ve()}function tn(){C=null,oe=!1,Ce=null,Me=[],se(document.getElementById("service-panel"),d?.service),nn(),ve()}function xi(e){if(!e)return null;const t=e.id||e.external_id||"";return!t||t.startsWith("http")||!t.includes(":")?null:t}function nn(){document.querySelectorAll(".pointer-tag").forEach(e=>{const t=e.dataset.tag;t&&e.classList.toggle("active",t===C)})}function sn(e){Ce=e;const t=on(),n=t?[{type:"owner",value:t,source:"node",locked:!0}]:[],i=C?[{type:"projection",value:C}]:[],s=xi(e);Me=s?[...n,...i,{type:"entity",value:s,source:"card"}]:[...n,...i],se(document.getElementById("service-panel"),d?.service),ve()}function an(e){const t=Me.find(s=>s.type==="owner")?.value||null,n=Fe.filter(s=>!(!Array.isArray(s.pointer_tags)||!s.pointer_tags.includes(e)||t&&!s.pointer_tags.includes(t))),i=ki(e);return{localResults:n,externalLinks:i}}function on(){return d?.type==="character"?`owner:${d.id}`:null}function ve(){const e=document.getElementById("context-strip");if(!e)return;const t=Ii(),i=Li(Me).map(a=>{const r=`${a.type}:${a.value}`,o=a.type!=="owner";return`
      <span class="context-pill context-pill--${a.type}" data-context-type="${a.type}" data-context-value="${a.value}">
        <span class="context-label">${p(r)}</span>
        ${a.source?`<span class="context-source">${p(a.source)}</span>`:""}
        ${a.locked?'<span class="context-lock">üîí</span>':""}
        ${o?'<button class="context-close" data-action="remove-context">√ó</button>':""}
      </span>`}).join(""),s=a=>t===a?" legend-active":"";e.innerHTML=`
    <div class="context-strip-row">
      <div class="context-response">${p(t)}</div>
      <div class="context-pills">${i||'<span class="context-empty">no context</span>'}</div>
      <div class="context-legend">
        <span class="legend-item legend-results${s("Results")}">Results</span>
        <span class="legend-item legend-actions${s("Actions")}">Actions</span>
        <span class="legend-item legend-steps${s("Steps")}">Steps</span>
        <span class="legend-item legend-info${s("Info")}">Info</span>
      </div>
    </div>
  `,e.querySelectorAll("[data-action='remove-context']").forEach(a=>{a.addEventListener("click",r=>{r.preventDefault();const o=a.closest(".context-pill");if(!o)return;const c=o.dataset.contextType,l=o.dataset.contextValue;c==="projection"&&l===C?tn():c==="entity"&&sn(null)})})}function Li(e){const t={owner:0,projection:1,entity:2};return[...e].sort((n,i)=>(t[n.type]??99)-(t[i.type]??99))}function Ii(){return oe&&C?"Results":d?.service?.actions?.length?"Actions":d?.type==="practice"?"Steps":"Info"}function ki(e){const t=jt.get(e),n=hi(e),i=t?.external_queries?.huggingface||n,s=t?.external_queries?.paperswithcode||n;return{huggingface:i?`https://huggingface.co/models?search=${encodeURIComponent(i)}`:null,paperswithcode:s?`https://paperswithcode.com/search?q=${encodeURIComponent(s)}`:null}}function Ti(e){const{localResults:t,externalLinks:n}=an(e),i={service:[],model:[],method:[],other:[]};t.forEach(f=>{i[f.kind]?i[f.kind].push(f):i.other.push(f)});const s=f=>f.map(h=>{const L=Wt.filter(m=>m.item_external_id===h.external_id).map(m=>m.practice_id).join(", "),w=h.external_id?.startsWith("http")?`<a class="query-link" href="${h.external_id}" target="_blank">Open</a>`:"",b=h.id||h.external_id||"";return`
      <div class="query-item" data-item-id="${p(b)}" data-item-kind="${p(h.kind||"")}">
        <div class="query-item-title">${p(h.title||h.display_name||h.external_id||"Item")}</div>
        <div class="query-item-meta">
          <span>${p(h.kind||"item")}</span>
          <span>${p(h.source||"unknown")}</span>
          ${L?`<span class="query-badge">participates: ${p(L)}</span>`:""}
          ${w}
        </div>
      </div>
    `}).join(""),a=(f,h)=>h.length?`
    <div class="query-section">
      <div class="query-section-title">${f}</div>
      ${s(h)}
    </div>
  `:"",r=t.length,o=Fe.length===0?"Catalog empty or missing.":r===0?"No matches for this tag.":`Matches: ${r}`,c=r>0?"Scroll to see results.":"",l=[n.huggingface?`<a class="query-external" href="${n.huggingface}" target="_blank">Open in Hugging Face</a>`:"",n.paperswithcode?`<a class="query-external" href="${n.paperswithcode}" target="_blank">Open in Papers with Code</a>`:""].join(""),S=t.length===0?'<div class="query-empty">No results for this tag.</div>':"",g=Ce?`
      <div class="opportunities">
        <div class="opportunities-title">You can do now</div>
        <div class="opportunity-item">–°–¥–µ–ª–∞—Ç—å –æ–±–∑–æ—Ä —Å–µ—Ä–≤–∏—Å–∞ (${p(Ce.name)}) ‚Äî –ù—ç–π ‚Äî soon</div>
        <div class="opportunity-item">–°–æ–±—Ä–∞—Ç—å —Ç—É—Ç–æ—Ä–∏–∞–ª –ø–∞–π–ø–ª–∞–π–Ω–∞ ‚Äî –†—É–Ω–∞ ‚Äî soon</div>
      </div>
    `:"";return`
    <div class="query-mode">
      <div class="query-header">
        <span class="query-label">Query Mode</span>
        <span class="pointer-tag active" data-tag="${e}">${p(e)}</span>
        <button class="query-reset" data-action="clear-query">√ó</button>
      </div>
      <div class="query-status">${p(o)}</div>
      ${c?`<div class="query-hint">${p(c)}</div>`:""}
      ${a("Services",i.service)}
      ${a("Models",i.model)}
      ${a("Methods",i.method)}
      ${a("Other",i.other)}
      ${l?`<div class="query-links">${l}</div>`:""}
      ${g}
      ${S}
    </div>
  `}function Pi(e){e.querySelectorAll("[data-action='clear-query']").forEach(t=>{t.addEventListener("click",()=>{tn()})}),e.querySelectorAll(".query-item").forEach(t=>{t.dataset.itemKind==="service"&&t.addEventListener("click",i=>{if(i.target?.closest("a"))return;const s=t.dataset.itemId,a=t.querySelector(".query-item-title")?.textContent||s;sn({id:s,name:a})})}),H(e)}function _e(e,t){const n=e?.querySelector(".panel-content");if(!n)return;let i=`<div class="text">${X(t?.text||"")}</div>`;t?.refs?.length&&(i+=`<div class="refs-section">
      <div class="refs-title">References</div>
      ${t.refs.map(s=>`
        <span class="ref-item" data-ref-id="${s.id}" data-ref-type="${s.type}">
          ${yt(s.type)} ${p(s.label||s.id)}
        </span>
      `).join("")}
    </div>`),n.innerHTML=i,H(n)}function se(e,t){const n=e?.querySelector(".panel-content");if(!n)return;if(C&&oe){n.innerHTML=Ti(C),Pi(n);return}let i=`<div class="text">${X(t?.text||"")}</div>`;const s=Array.isArray(t?.actions)?t.actions:[],a=s.filter(o=>o.type==="workbench"),r=s.filter(o=>o.type!=="workbench");a.length&&(i+=`<div class="workbench-section">
      <div class="workbench-title">Workbenches</div>
      ${a.map(o=>`
        <button class="action-button" data-action-type="${o.type}" data-action-id="${o.id||""}">
          ${Nt(o.type)} ${p(o.label)}
        </button>
      `).join("")}
    </div>`),r.length&&(i+=`<div class="actions-section">
      ${r.map(o=>`
        <button class="action-button" data-action-type="${o.type}" data-action-id="${o.id||""}">
          ${Nt(o.type)} ${p(o.label)}
        </button>
      `).join("")}
    </div>`),n.innerHTML=i,H(n),n.querySelectorAll(".action-button").forEach(o=>{o.addEventListener("click",()=>{q(),B.resumeIfNeeded(),Ci(o.dataset.actionType)})})}function Ci(e){switch(e){case"navigate":pt();break;case"restart":F(N.start_node_id);break}}function Mi(){const e=document.getElementById("prev-btn"),t=document.getElementById("next-btn"),n=document.getElementById("step-indicator");e&&(e.disabled=!ei()),t&&(t.disabled=!Zn()),n&&N&&(n.textContent=`${d?.label||""} (${Bt+1}/${N.nodes.length})`)}function p(e){const t=document.createElement("div");return t.textContent=e||"",t.innerHTML}function yt(e){return""}function Nt(e){return""}function pe(e){document.body.classList.remove("focus-story","focus-system","focus-service"),e==="story-panel"&&document.body.classList.add("focus-story"),e==="system-panel"&&document.body.classList.add("focus-system"),e==="service-panel"&&document.body.classList.add("focus-service")}function Ai(){const e=document.createElement("div");e.id="header-trigger",document.body.appendChild(e);const t=document.createElement("div");t.id="header-bar",t.innerHTML=`
    <div class="header-left">
      <div class="header-logo-circle" style="background-image: url('${Oe.LOGOS}/brands/logo-ii.png')"></div>
      <span class="header-logo">–í–æ–≤–∞ –∏ –ü–µ—Ç—Ä–æ–≤–∞</span>
    </div>
    <div class="header-center">
      <div class="social-links">
        <span class="social-link" title="Telegram">TG</span>
        <span class="social-link" title="GitHub">GH</span>
        <span class="social-link" title="YouTube">YT</span>
      </div>
    </div>
    <div class="header-right">
      <button class="header-btn" title="Coming soon">Donate</button>
      <button class="header-btn" title="Coming soon">Sign in</button>
      <button class="header-btn" title="Coming soon">RU</button>
    </div>
  `,document.body.appendChild(t);const n=document.createElement("div");n.id="graph",document.body.appendChild(n);const i=document.createElement("div");i.id="panels-container",i.innerHTML=`
    <div id="story-panel" class="panel-3s">
      <div class="panel-content"></div>
    </div>
    <div class="graph-spacer"></div>
    <div id="right-column">
      <div id="context-strip" class="context-strip"></div>
      <div id="system-panel" class="panel-3s">
        <div class="panel-content"></div>
      </div>
      <div id="service-panel" class="panel-3s">
        <div class="panel-content"></div>
      </div>
    </div>
  `,document.body.appendChild(i);const s=document.getElementById("story-panel"),a=document.getElementById("system-panel"),r=document.getElementById("service-panel");pe("story-panel"),a?.addEventListener("mouseenter",()=>pe("system-panel")),r?.addEventListener("mouseenter",()=>pe("service-panel")),s?.addEventListener("mouseenter",()=>pe("story-panel")),a?.addEventListener("mouseleave",()=>pe("story-panel")),r?.addEventListener("mouseleave",()=>pe("story-panel"));const o=document.createElement("div");o.id="nav-bar",o.innerHTML=`
    <button id="prev-btn" class="nav-button">‚Üê Prev</button>
    <span id="step-indicator">Loading...</span>
    <button id="next-btn" class="nav-button">Next ‚Üí</button>
    <div id="view-switcher" class="view-switcher">
      <button class="nav-button view-button" data-view="knowledge">Knowledge</button>
      <button class="nav-button view-button" data-view="system">System</button>
      <button class="nav-button view-button" data-view="all">All</button>
    </div>
    <button id="reload-btn" class="nav-button reload-button" title="Reload route from contracts">üîÑ</button>
    <span id="graph-stats" class="graph-stats"></span>
  `,document.body.appendChild(o),document.getElementById("prev-btn")?.addEventListener("click",()=>{q(),B.resumeIfNeeded(),Qt()}),document.getElementById("next-btn")?.addEventListener("click",()=>{q(),B.resumeIfNeeded(),pt()}),document.getElementById("reload-btn")?.addEventListener("click",()=>{q(),Xn()}),document.querySelectorAll(".view-button").forEach(c=>{c.addEventListener("click",()=>{if(ye!=="canon")return;const l=c.dataset.view||"all";cn(l)})})}function rn(){De=performance.now(),Gn(De),Vn(De),W.update(),requestAnimationFrame(rn)}u.onEngineTick(()=>{B.tick(u.graphData().nodes)});window.addEventListener("resize",()=>{u.width(window.innerWidth).height(window.innerHeight)});document.addEventListener("keydown",e=>{q(),e.key==="ArrowLeft"&&Qt(),e.key==="ArrowRight"&&pt()});["wheel","pointerdown","touchstart"].forEach(e=>{window.addEventListener(e,()=>{q(),B.resumeIfNeeded()},{passive:!0})});u.width(window.innerWidth).height(window.innerHeight);rn();const Je=new URLSearchParams(window.location.search),_t=Je.get("route"),Ri=Je.get("source"),Ni=Je.get("graphUrl"),_i=Je.get("view");ye=Ri||"canon";Ot=Ni||k.defaultGraphUrl;ae=_i||"all";Fn();Qn();ye==="demo"&&_t?Ge(_t):ye==="demo"?Ge(k.defaultRoute):Ft();cn(ae);function cn(e){if(ae=e||"all",qi(),ye!=="canon")return;st&&ut(Ut(st,ae));const t=new URLSearchParams(window.location.search);t.set("view",ae),history.replaceState(null,"",`${window.location.pathname}?${t}`)}function qi(){document.querySelectorAll(".view-button").forEach(e=>{e.dataset.view===ae?e.classList.add("active"):e.classList.remove("active")})}
