import{S as at,_ as ot,A as it,D as rt,M as Te,C as ce,d as Ce,B as ct,F as Pe,a as dt,b as lt,c as ut,G as ht,e as H,Q as Ue,z as mt,V as $,L as gt}from"./3d-force-graph-Qkr9Kv2e.js";import{l as ft}from"./adapter-CtpVqGLt.js";import{l as pt,G as yt}from"./loadGraphConfig-g9rs-1sD.js";import{V as v}from"./config-C8ziI3q8.js";sn();document.documentElement.style.setProperty("--panel-bg","rgba(10, 12, 16, 0.55)");const wt=300,vt=.5,O=v.node.minRadius,bt=.07,Et=.0016,St=.08,Lt=.0013,xt=.18,Mt=2200,zt=document.getElementById("graph"),ge=document.getElementById("dataStatus"),Re=document.getElementById("error"),Se=document.getElementById("warning"),It=document.getElementById("searchInput"),Tt=document.getElementById("typeFilters"),Ct=document.getElementById("statusFilters"),Rt=document.getElementById("resetCamera"),At=document.getElementById("simplifyToggle"),Ae=document.getElementById("weightThreshold"),Nt=document.getElementById("soundToggle"),je=document.getElementById("soundVolume"),re=document.getElementById("audioHint"),$e=document.getElementById("modeToggle"),fe=document.getElementById("dropOverlay"),W=document.getElementById("fullscreenBtn"),T=new URLSearchParams(window.location.search),Oe=T.get("mode"),Ne=Oe==="showcase"?"showcase":Oe==="embed"?"embed":"author",J=T.get("focus"),Le=T.get("highlightType"),xe=T.get("highlightStatus"),Bt=T.get("source")||"demo",kt=T.get("view")||"all",Dt=T.get("graphUrl")||"universe.json",S={text:"",types:new Set,statuses:new Set,simplify:!1,weightThreshold:vt},K=v.colors;let h={nodes:[],links:[]},q=new Set,Me=new Set,de=new Set,I=new Map,A=new Map,P=null,ue=!1,pe=Ne!=="showcase"&&Ne!=="embed",he=!!J;const Ft=new Set,X=new Set,Pt=new at(1,48,48),ze=new Map,ee=new Map,ye=new Map,Y=new Map,Q=new Map;let le=0,He=0,Ge=0;const i=ot()(zt).backgroundColor(v.colors.background).showNavInfo(!1).nodeRelSize(O).linkOpacity(.35).linkWidth(.6).linkDirectionalParticles(0);i.d3Force("link").distance(e=>$t(e));i.d3VelocityDecay(.2);i.d3AlphaDecay(.02);i.scene().add(new it(16777215,.7));const qe=new rt(16777215,.8);qe.position.set(40,60,120);i.scene().add(qe);const We=i.camera();We.fov=v.camera.fov;We.updateProjectionMatrix();i.nodeLabel(e=>e.label?`${e.label} (${e.id})`:e.id);i.nodeColor(e=>me(e));i.nodeThreeObject(e=>Ut(e));i.nodeThreeObjectExtend(!1);i.linkThreeObject(e=>Vt());i.linkPositionUpdate((e,t,n)=>{_t(e,t,n)});i.linkColor(e=>X.has(e)?K.highlight:K.linkDefault);i.nodeVal(e=>Z(e)/O);i.linkWidth(e=>X.has(e)?1.6:.6);const M=i.controls();M.enableDamping=!0;M.dampingFactor=.08;M.rotateSpeed=.6;M.zoomSpeed=.8;M.autoRotate=!0;M.autoRotateSpeed=xt;function f(e){return e&&typeof e=="object"?e.id:e}function me(e){const t=K.nodeDefault;if(!Le&&!xe)return t;const n=Le&&e.type===Le,s=xe&&e.status===xe;return n||s?t:K.dim}function Z(e){return e.visualRadius&&Number.isFinite(e.visualRadius)?e.visualRadius:e.size&&Number.isFinite(e.size)?Math.min(v.node.maxRadius,Math.max(v.node.minRadius,e.size)):e.type==="hub"||e.type==="root"?O*4:O}function Ut(e){const t=new Te(Pt,Ot(me(e))),n=Z(e);if(t.scale.setScalar(n),ee.set(e.id,t),ye.set(e.id,n),!Y.has(e.id)){const s=ve(String(e.id))%1e3;Y.set(e.id,s/1e3*Math.PI*2)}return t}function Ot(e){const t=String(e).toLowerCase();if(ze.has(t))return ze.get(t);const n=new ce(e),s=new Ce({color:n.clone().multiplyScalar(.6),emissive:n.clone(),emissiveIntensity:.2,roughness:.3,metalness:0,transparent:!1,opacity:1});return s.onBeforeCompile=a=>{a.uniforms.rimColor={value:n},a.uniforms.rimPower={value:2.2},a.uniforms.rimStrength={value:.9},a.fragmentShader=a.fragmentShader.replace("#include <output_fragment>",["float rim = pow(1.0 - max(dot(normalize(vNormal), normalize(vViewPosition)), 0.0), rimPower);","vec3 rimLight = rimColor * rim * rimStrength;","gl_FragColor = vec4(outgoingLight + rimLight, diffuseColor.a);"].join(`
`))},ze.set(t,s),s}function Gt(){const e=[new $(1,0),new $(.6,.18),new $(.3,.52),new $(.08,.9),new $(0,1)],t=new gt(e,28);return t.computeVertexNormals(),t}function Vt(e){const t=new ct;t.setAttribute("position",new Pe([0,0,0,0,0,0,0,0,0],3)),t.setAttribute("color",new Pe([1,1,1,1,1,1,1,1,1],3));const n=new dt({vertexColors:!0,transparent:!0,opacity:.45,blending:lt}),s=new ut(t,n),a=Gt(),o=new Ce({color:16777215,transparent:!1,opacity:1,depthWrite:!0}),r=new Ce({color:16777215,transparent:!1,opacity:1,depthWrite:!0}),l=new Te(a,o),u=new Te(a,r),b=new ht;return b.add(s),b.add(l),b.add(u),b.userData={line:s,nozzleA:l,nozzleB:u},b}function _t(e,t,n){const{line:s,nozzleA:a,nozzleB:o}=e.userData,r=new H(t.start.x,t.start.y,t.start.z),l=new H(t.end.x,t.end.y,t.end.z),u=l.clone().sub(r),b=Math.max(1e-4,u.length()),z=u.clone().normalize(),G=1+Math.sin(le*Lt+jt(n))*St,N=A.get(f(n.source)),B=A.get(f(n.target)),k=new ce(N?me(N):Ie()),D=new ce(B?me(B):Ie()),p=new ce(Ie()),c=s.geometry.getAttribute("color");c.array[0]=k.r,c.array[1]=k.g,c.array[2]=k.b,c.array[3]=p.r,c.array[4]=p.g,c.array[5]=p.b,c.array[6]=D.r,c.array[7]=D.g,c.array[8]=D.b,c.needsUpdate=!0;const m=X.has(n);s.material.opacity=m?.85:.4;const E=N?Z(N):O,d=B?Z(B):O;let g=Math.min(b*.45,E*2)*G,y=Math.min(b*.45,d*2)*G;const L=E*.35,C=d*.35,ne=Math.max(.001,b-E-d),se=g+y;if(se>ne*.9){const j=ne*.9/se;g*=j,y*=j}const ae=E*.45,oe=d*.45,V=r.clone().add(z.clone().multiplyScalar(E-ae)),_=l.clone().add(z.clone().multiplyScalar(-(d-oe))),R=V.clone().add(z.clone().multiplyScalar(g)),x=_.clone().add(z.clone().multiplyScalar(-y)),F=R.clone().add(x).multiplyScalar(.5),w=s.geometry.getAttribute("position");w.array[0]=R.x,w.array[1]=R.y,w.array[2]=R.z,w.array[3]=F.x,w.array[4]=F.y,w.array[5]=F.z,w.array[6]=x.x,w.array[7]=x.y,w.array[8]=x.z,w.needsUpdate=!0,a.visible=!0,o.visible=!0;const ie=new Ue().setFromUnitVectors(new H(0,1,0),z),Fe=new Ue().setFromUnitVectors(new H(0,1,0),z.clone().multiplyScalar(-1));a.quaternion.copy(ie),o.quaternion.copy(Fe),a.position.copy(V),o.position.copy(_),a.scale.set(L,g,L),o.scale.set(C,y,C),a.material.color.copy(k),o.material.color.copy(D),a.material.opacity=1,o.material.opacity=1}function jt(e){const t=e.id||`${f(e.source)}-${f(e.target)}`;if(Q.has(t))return Q.get(t);const s=ve(String(t))%1e3/1e3*Math.PI*2;return Q.set(t,s),s}function Qe(e){const t=e.weight??e.value??e.meta?.weight;return typeof t=="number"?t:null}function Ie(){return K.link}function $t(e){const t=v.link.baseLength,n=v.link.lengthVariance,a=ve(String(e.id||`${f(e.source)}-${f(e.target)}`))%1e3/1e3,o=t+(a-.5)*n*2,r=e.source?.type||A.get(f(e.source))?.type,l=e.target?.type||A.get(f(e.target))?.type,u=new Set(["system","layer"]);return u.has(r)&&u.has(l)?o*v.link.shortClusterFactor:o}function Ht(e){A=new Map(e.nodes.map(t=>[t.id,t])),I=new Map,e.links.forEach(t=>{const n=f(t.source),s=f(t.target);I.has(n)||I.set(n,new Set),I.has(s)||I.set(s,new Set),I.get(n).add(s),I.get(s).add(n)})}function qt(e){e>wt?(Se.textContent=`Heavy graph: ${e} nodes`,Se.classList.remove("hidden")):Se.classList.add("hidden")}function Wt(e,t,n){ge.textContent=`${e} - ${t} nodes / ${n} links`}function U(e){Re.textContent=e,Re.classList.remove("hidden")}function Be(){Re.classList.add("hidden")}function Ve(e,t,n){e.innerHTML="",n.clear(),t.forEach(s=>{const a=document.createElement("label");a.className="chip";const o=document.createElement("input");o.type="checkbox",o.value=s,o.checked=!0,o.addEventListener("change",()=>{o.checked?n.add(s):n.delete(s),te()});const r=document.createElement("span");r.textContent=s,a.appendChild(o),a.appendChild(r),e.appendChild(a),n.add(s)})}function te(){const e=S.text,t=S.types,n=S.statuses;Me=new Set,q=new Set,h.nodes.forEach(s=>{const a=(s.label||"").toLowerCase(),o=String(s.id||"").toLowerCase(),r=!e||a.includes(e)||o.includes(e),l=t.size===0||t.has(s.type),u=n.size===0||n.has(s.status);r&&l&&u&&(Me.add(s),q.add(s.id))}),de=new Set,h.links.forEach(s=>{const a=f(s.source),o=f(s.target);if(!(!q.has(a)||!q.has(o))){if(S.simplify){const r=Qe(s);if(r!==null&&r<S.weightThreshold)return}de.add(s)}}),i.nodeVisibility(s=>Me.has(s)),i.linkVisibility(s=>de.has(s)),Je(),i.refresh()}function Je(){Ft.clear(),X.clear(),P&&q.has(P.id)&&h.links.forEach(e=>{const t=f(e.source),n=f(e.target);(t===P.id||n===P.id)&&de.has(e)&&X.add(e)})}function ke(e,t){Be(),ee.clear(),ye.clear(),Y.clear(),Q.clear();let n;try{n=ft(e)}catch(s){U(s.message);return}Ke(n,t)}function Qt(e,t){if(Be(),ee.clear(),ye.clear(),Y.clear(),Q.clear(),!e||!Array.isArray(e.nodes)||!Array.isArray(e.links)){U("Invalid graph data");return}Ke(e,t)}function Ke(e,t){h=e,en(h),i.graphData(h),Ht(h);const n=Array.from(new Set(h.nodes.map(r=>r.type).filter(Boolean))).sort(),s=Array.from(new Set(h.nodes.map(r=>r.status).filter(Boolean))).sort();Ve(Tt,n,S.types),Ve(Ct,s,S.statuses);const a=h.links.map(Qe).filter(r=>r!==null),o=a.length?Math.max(...a):1;Ae.max=String(Math.max(1,o)),Ae.value=String(Math.min(S.weightThreshold,o)),Wt(t,h.nodes.length,h.links.length),qt(h.nodes.length),te(),setTimeout(()=>{i.zoomToFit(800,60),be(),he&&J&&Ye(J)},200)}async function Jt(e){Be(),ge.textContent="Loading URL...";const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch ${e} (${t.status})`);const n=await t.json();ke(n,"URL")}async function Kt(){const e=new URL("../../data/sample.cosmos-map.v0.1.json",import.meta.url);ge.textContent="Loading sample...";const n=await(await fetch(e)).json();ke(n,"Sample")}async function Xt(){ge.textContent="Loading canon...";const e=await pt(yt.EXTERNAL,{externalUrl:Dt,view:kt});Qt({nodes:e.nodes,links:e.links},"Canon")}const we=(()=>{let e=null,t=null,n=!1,s=Number(je.value||.15);const a=new Map,o=new Map,r=180,l=240,u=.35,b=3.5;function z(){e||(e=new AudioContext,t=e.createGain(),t.gain.value=s,t.connect(e.destination)),e.state==="suspended"?re.classList.remove("hidden"):re.classList.add("hidden")}function Ee(p,c,m,E){if(!n||!e||e.state!=="running")return;const d=e.createOscillator(),g=e.createGain(),y=e.createBiquadFilter();d.type="sine",d.frequency.value=p,y.type="lowpass",y.frequency.value=420+Math.random()*180,y.Q.value=.8,d.connect(y),y.connect(g),g.connect(t);const L=e.currentTime+E,C=s*m;g.gain.setValueAtTime(1e-4,L),g.gain.exponentialRampToValueAtTime(C,L+.03),g.gain.exponentialRampToValueAtTime(1e-4,L+c),d.start(L),d.stop(L+c+.05)}function G(p){const c=v.node.minRadius,m=v.node.maxRadius,d=(Z(p)-c)/(m-c);return 320-Math.min(1,Math.max(0,d))*170}function N(p){if(!n||!e||e.state!=="running")return;const c=performance.now();p.forEach(m=>{const E=m.vx||0,d=m.vy||0,g=m.vz||0,y=Math.sqrt(E*E+d*d+g*g);if(y<u)return;const L=a.get(m.id)||0;if(c-L<r)return;a.set(m.id,c);const C=Math.min(1,y/b),ne=G(m),se=(Math.random()-.5)*8,ae=.16+C*.2,oe=.08+C*.22;Ee(ne+se,ae,oe,Math.random()*.04);const V=I.get(m.id);if(!V)return;let _=0;V.forEach(R=>{if(_>=2)return;const x=A.get(R);if(!x)return;const F=x.vx||0,w=x.vy||0,ie=x.vz||0;if(Math.sqrt(F*F+w*w+ie*ie)<u*.7)return;const j=`${m.id}:${R}`,et=o.get(j)||0;if(c-et<l)return;o.set(j,c);const tt=G(x)+(Math.random()-.5)*10,nt=oe*.7,st=.06+Math.random()*.09;Ee(tt,ae*.85,nt,st),_+=1})})}function B(p){n=p,n?z():re.classList.add("hidden")}function k(p){s=p,t&&(t.gain.value=s)}async function D(){e&&e.state==="suspended"&&(await e.resume(),re.classList.add("hidden"))}return{setEnabled:B,setVolume:k,resumeIfNeeded:D,tick:N}})();i.onNodeHover(e=>{e!==P&&(P=e||null,Je(),i.refresh())});i.onNodeDrag(e=>{De(),e.fx=e.x,e.fy=e.y,e.fz=e.z,ue||(ue=!0)});i.onNodeDragEnd(e=>{e.fx=null,e.fy=null,e.fz=null,ue=!1});Rt.addEventListener("click",()=>{i.zoomToFit(800,60),be()});It.addEventListener("input",e=>{S.text=e.target.value.trim().toLowerCase(),te()});At.addEventListener("change",e=>{S.simplify=e.target.checked,te()});Ae.addEventListener("input",e=>{S.weightThreshold=Number(e.target.value),te()});Nt.addEventListener("change",e=>{we.setEnabled(e.target.checked)});je.addEventListener("input",e=>{we.setVolume(Number(e.target.value))});$e.addEventListener("click",()=>{const e=document.body.classList.contains("mode-showcase")?"author":"showcase";Xe(e)});document.addEventListener("pointerdown",()=>{we.resumeIfNeeded(),De()});function Xe(e){const t=e==="showcase",n=e==="embed";document.body.classList.toggle("mode-showcase",t),document.body.classList.toggle("mode-embed",n),$e.textContent=`Mode: ${n?"embed":t?"showcase":"author"}`,Yt(!t&&!n),Zt(n)}function Yt(e){pe=e,e||fe.classList.add("hidden")}function Zt(e){W&&(e&&document.fullscreenEnabled?W.classList.remove("hidden"):W.classList.add("hidden"))}window.addEventListener("dragover",e=>{pe&&(e.preventDefault(),fe.classList.remove("hidden"))});window.addEventListener("dragleave",()=>{pe&&fe.classList.add("hidden")});window.addEventListener("drop",e=>{if(!pe)return;e.preventDefault(),fe.classList.add("hidden");const t=e.dataTransfer.files[0];if(!t)return;const n=new FileReader;n.onload=()=>{try{const s=JSON.parse(n.result);ke(s,"File")}catch{U("Invalid JSON file")}},n.readAsText(t)});W&&W.addEventListener("click",()=>{document.fullscreenEnabled&&(document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen())});function Ye(e){const t=A.get(e);if(!t){he=!1;return}if(t.x===void 0)return;const s=1+120/Math.max(1,Math.hypot(t.x||0,t.y||0,t.z||0));i.cameraPosition({x:(t.x||0)*s,y:(t.y||0)*s,z:(t.z||0)*s},t,1200),he=!1}function en(e){const t=v.node.minRadius,n=v.node.maxRadius,s=Math.max(.1,n-t);e.nodes.forEach((a,o)=>{const l=ve(a.id||String(o))%1e3/1e3;a.visualRadius=t+l*s})}function ve(e){let t=0;for(let n=0;n<e.length;n+=1)t=t*31+e.charCodeAt(n)|0;return Math.abs(t)}function tn(e){const t=e*Et;ee.forEach((n,s)=>{const a=ye.get(s);if(!a)return;const o=Y.get(s)||0,r=1+Math.sin(t+o)*bt;n.scale.setScalar(a*r)})}function be(){const e=i.getGraphBbox?.();let t=null;if(e&&e.x&&e.y&&e.z){const a=e.x[1]-e.x[0],o=e.y[1]-e.y[0],r=e.z[1]-e.z[0],l=Math.max(1,Math.sqrt(a*a+o*o+r*r)*.5),u=mt.degToRad(i.camera().fov||60);t=l/Math.sin(u/2)}const n=i.camera().position.length()||1,s=(t||n)*1.6;M.maxDistance=Math.max(s,200)}function De(){He=performance.now(),M.autoRotate=!1}function nn(e){if(ue)return;const t=e-He>Mt;M.autoRotate=t,t&&(Ge+=25e-5,i.scene().rotation.y=Ge)}function Ze(){le=performance.now(),tn(le),nn(le),M.update(),requestAnimationFrame(Ze)}i.onEngineStop(()=>{he&&J&&Ye(J),be()});i.onEngineTick(()=>{we.tick(h.nodes),h.nodes.forEach(e=>{const t=ee.get(e.id);if(!t||e.x===void 0)return;const n=new H(e.x,e.y,e.z);t.position.copy(n)})});window.addEventListener("resize",()=>{i.width(window.innerWidth).height(window.innerHeight),be()});i.width(window.innerWidth).height(window.innerHeight);Xe(Ne);Ze();["wheel","keydown","touchstart"].forEach(e=>{window.addEventListener(e,De,{passive:!0})});const _e=T.get("dataUrl");Bt==="canon"?Xt().catch(e=>{U(e.message)}):_e?Jt(_e).catch(e=>{U(e.message)}):Kt().catch(e=>{U(e.message)});function sn(){if(document.getElementById("ui"))return;const e=document.createElement("div");for(e.innerHTML=`
    <div id="ui" class="panel" data-mode="author">
      <div class="brand">dream-graph</div>
      <div class="section">
        <div class="section-title">Data</div>
        <div id="dataStatus" class="status">Loading...</div>
        <button id="resetCamera" class="btn">Reset Camera</button>
      </div>
      <div class="section">
        <div class="section-title">Search</div>
        <input id="searchInput" class="input" type="search" placeholder="label or id" />
      </div>
      <div class="section">
        <div class="section-title">Type</div>
        <div id="typeFilters" class="chip-list"></div>
      </div>
      <div class="section">
        <div class="section-title">Status</div>
        <div id="statusFilters" class="chip-list"></div>
      </div>
      <div class="section">
        <div class="section-title">Links</div>
        <label class="checkbox">
          <input id="simplifyToggle" type="checkbox" />
          Simplify by weight
        </label>
        <input id="weightThreshold" class="range" type="range" min="0" max="1" step="0.05" value="0.5" />
      </div>
      <div class="section">
        <div class="section-title">Sound</div>
        <label class="checkbox">
          <input id="soundToggle" type="checkbox" />
          Sound
        </label>
        <input id="soundVolume" class="range" type="range" min="0" max="1" step="0.05" value="0.15" />
        <div id="audioHint" class="hint hidden">click to enable audio</div>
      </div>
      <div class="section">
        <button id="modeToggle" class="btn secondary">Mode: author</button>
      </div>
      <div id="warning" class="warning hidden"></div>
      <div id="error" class="error hidden"></div>
    </div>
    <div id="showcaseBadge" class="badge">dream-graph</div>
    <div id="dropOverlay" class="drop-overlay hidden">Drop cosmos-map JSON to load</div>
    <button id="fullscreenBtn" class="fullscreen-btn hidden" type="button">Fullscreen</button>
  `;e.firstElementChild;)document.body.appendChild(e.firstElementChild)}
