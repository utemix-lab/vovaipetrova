import{S as Y,_ as K,A as V,D as W,M as J,C as X,d as Q}from"./3d-force-graph-CFjuoTfL.js";const d={ROUTE:"route",TERM:"term",DIGEST:"digest",EPISODE:"episode"},b={ROUTE_CHILD_OF:"ROUTE_CHILD_OF",ROUTE_MENTIONS_TERM:"ROUTE_MENTIONS_TERM",TERM_LINKS_ROUTE:"TERM_LINKS_ROUTE",DIGEST_HAS_EPISODE:"DIGEST_HAS_EPISODE"},P={[d.ROUTE]:"Маршрут",[d.TERM]:"Термин KB",[d.DIGEST]:"Дайджест Stories",[d.EPISODE]:"Эпизод Stories"},Z={type:{[d.ROUTE]:"#38bdf8",[d.TERM]:"#a78bfa",[d.DIGEST]:"#fb923c",[d.EPISODE]:"#fbbf24"}};function q(e){if(e==="/")return"home";const t=e.split("/").filter(Boolean);if(t.length===0)return"home";const s=t[0];return s==="page"?"page":s==="kb"?"kb":s}function ee(e){if(e==="/"||!e)return null;const t=e.split("/").filter(Boolean);return t.length<=1?"/":(t.pop(),"/"+t.join("/"))}function te(e){const{routes:t={},glossary:s=[],digests:o=[]}=e,c=[],l=[],r=new Set,O=t.routes||[],m=new Map;O.forEach(n=>{const i=`route:${n.path}`;if(r.has(i))return;r.add(i);const f=q(n.path);c.push({id:i,label:n.title||n.path,type:d.ROUTE,status:n.in_sitemap?"active":"draft",props:{path:n.path,in_sitemap:n.in_sitemap,og_title:n.og?.title||null,og_description:n.og?.description||null,section:f}}),m.set(n.path,i)}),O.forEach(n=>{const i=ee(n.path);i&&m.has(i)&&l.push({source:`route:${n.path}`,target:m.get(i),kind:b.ROUTE_CHILD_OF,directed:!0,weight:1})});const k=new Map;return s.forEach(n=>{const i=`term:${n.slug}`;if(!r.has(i)&&(r.add(i),c.push({id:i,label:n.title||n.slug,type:d.TERM,status:"active",props:{slug:n.slug,lite_summary:n.lite_summary||"",link:n.link||null}}),k.set(n.slug,i),n.link)){const f=ne(n.link);f&&m.has(f)&&l.push({source:i,target:m.get(f),kind:b.TERM_LINKS_ROUTE,directed:!0,weight:2})}}),O.forEach(n=>{if(!n.path.startsWith("/kb/"))return;const i=n.path.replace("/kb/","").replace(/\/$/,"");k.has(i)&&l.push({source:`route:${n.path}`,target:k.get(i),kind:b.ROUTE_MENTIONS_TERM,directed:!0,weight:3})}),o.forEach(n=>{const i=`digest:${n.slug}`;if(r.has(i))return;r.add(i),c.push({id:i,label:n.title||n.slug,type:d.DIGEST,status:"active",props:{slug:n.slug,summary:n.summary||"",generated_at:n.generated_at||null}}),(n.episodes||[]).forEach((g,z)=>{const D=g.link?g.link.replace(/\.md$/,""):`${n.slug}-ep-${z}`,S=`episode:${D}`;r.has(S)||(r.add(S),c.push({id:S,label:g.title||D,type:d.EPISODE,status:"active",props:{slug:D,date:g.date||null,description:g.description||"",pr_links:g.pr_links||[]}})),l.push({source:i,target:S,kind:b.DIGEST_HAS_EPISODE,directed:!0,weight:2})})}),{schema:"cosmos-map.v0.1",nodes:c,links:l}}function ne(e){if(!e)return null;const t=e.match(/^kb\/([^.]+)\.md$/);return t?`/kb/${t[1]}`:null}async function se(e){const[t,s,o]=await Promise.all([fetch(e.routes).then(r=>r.json()),fetch(e.glossary).then(r=>r.text()),fetch(e.digests).then(r=>r.text())]),c=x(s),l=x(o);return te({routes:t,glossary:c,digests:l})}function x(e){return e.split(/\r?\n/).filter(t=>t.trim()).map(t=>{try{return JSON.parse(t)}catch{return null}}).filter(Boolean)}const y={node:{minRadius:2},link:{baseLength:55},colors:{background:"#0a0a0f",linkDefault:"#475569",nodeDefault:"#94a3b8",highlight:"#f8fafc",type:Z.type},camera:{fov:65}},oe={[d.ROUTE]:3.5,[d.TERM]:2.8,[d.DIGEST]:4,[d.EPISODE]:2.2};function B(e){return oe[e.type]||y.node.minRadius}be();document.documentElement.style.setProperty("--panel-bg","rgba(15, 23, 42, 0.85)");const F=y.node.minRadius,p=y.colors,ae=document.getElementById("graph"),$=document.getElementById("dataStatus"),M=document.getElementById("error"),ie=document.getElementById("searchInput"),re=document.getElementById("typeFilters"),ce=document.getElementById("resetCamera"),R=new URLSearchParams(window.location.search),le={routes:R.get("routesUrl")||"https://raw.githubusercontent.com/utemix-lab/vovaipetrova-core/main/static/routes.json",glossary:R.get("glossaryUrl")||"https://raw.githubusercontent.com/utemix-lab/vovaipetrova-core/main/kb_glossary_lite.jsonl",digests:R.get("digestsUrl")||"https://raw.githubusercontent.com/utemix-lab/vovaipetrova-core/main/prototype/data/stories_digests.jsonl"},_={text:"",types:new Set};let u={nodes:[],links:[]},E=new Set,C=new Set,T=new Set,h=null;const U=new Set,w=new Set,de=new Y(1,32,32),L=new Map,G=new Map,a=K()(ae).backgroundColor(p.background).showNavInfo(!1).nodeRelSize(F).linkOpacity(.4).linkWidth(.5).linkDirectionalParticles(0);a.d3Force("link").distance(()=>y.link.baseLength);a.d3VelocityDecay(.25);a.d3AlphaDecay(.025);a.scene().add(new V(16777215,.6));const A=new W(16777215,.7);A.position.set(30,50,100);a.scene().add(A);const H=a.camera();H.fov=y.camera.fov;H.updateProjectionMatrix();a.nodeLabel(e=>{const t=P[e.type]||e.type;return`${e.label} [${t}]`});a.nodeColor(e=>j(e));a.nodeThreeObject(e=>ue(e));a.nodeThreeObjectExtend(!1);a.nodeVal(e=>B(e)/F);a.linkColor(e=>w.has(e)?p.highlight:p.linkDefault);a.linkWidth(e=>w.has(e)?1.4:.5);const v=a.controls();v.enableDamping=!0;v.dampingFactor=.1;v.rotateSpeed=.5;v.zoomSpeed=.7;function j(e){return p.type[e.type]||p.nodeDefault}function ue(e){const t=j(e),s=he(t),o=new J(de,s),c=B(e);return o.scale.setScalar(c),G.set(e.id,o),o}function he(e){const t=String(e).toLowerCase();if(L.has(t))return L.get(t);const s=new X(e),o=new Q({color:s.clone().multiplyScalar(.7),emissive:s.clone(),emissiveIntensity:.25,roughness:.4,metalness:0});return L.set(t,o),o}function I(e){return e&&typeof e=="object"?e.id:e}function pe(e){new Map(e.nodes.map(t=>[t.id,t]))}function fe(e,t){$.textContent=`Core Taxonomy — ${e} nodes / ${t} links`}function ge(e){M.textContent=e,M.classList.remove("hidden")}function me(){M.classList.add("hidden")}function Ee(e,t,s){e.innerHTML="",s.clear(),t.forEach(o=>{const c=document.createElement("label");c.className="chip";const l=document.createElement("input");l.type="checkbox",l.value=o,l.checked=!0,l.addEventListener("change",()=>{l.checked?s.add(o):s.delete(o),N()});const r=document.createElement("span");r.textContent=P[o]||o,r.style.color=p.type[o]||p.nodeDefault,c.appendChild(l),c.appendChild(r),e.appendChild(c),s.add(o)})}function N(){const e=_.text,t=_.types;C=new Set,E=new Set,u.nodes.forEach(s=>{const o=(s.label||"").toLowerCase(),c=String(s.id||"").toLowerCase(),l=!e||o.includes(e)||c.includes(e),r=t.size===0||t.has(s.type);l&&r&&(C.add(s),E.add(s.id))}),T=new Set,u.links.forEach(s=>{const o=I(s.source),c=I(s.target);E.has(o)&&E.has(c)&&T.add(s)}),a.nodeVisibility(s=>C.has(s)),a.linkVisibility(s=>T.has(s)),a.refresh()}function ye(e){me(),G.clear(),u=e,a.graphData(u),pe(u);const t=Array.from(new Set(u.nodes.map(s=>s.type).filter(Boolean)));Ee(re,t,_.types),fe(u.nodes.length,u.links.length),N(),setTimeout(()=>{a.zoomToFit(800,80)},300)}async function Se(){$.textContent="Loading Core Taxonomy...";try{const e=await se(le);ye(e)}catch(e){ge(`Failed to load data: ${e.message}`)}}a.onNodeHover(e=>{e!==h&&(h=e||null,U.clear(),w.clear(),h&&E.has(h.id)&&(U.add(h),u.links.forEach(t=>{const s=I(t.source),o=I(t.target);(s===h.id||o===h.id)&&T.has(t)&&w.add(t)})),a.refresh())});ce.addEventListener("click",()=>{a.zoomToFit(800,80)});ie.addEventListener("input",e=>{_.text=e.target.value.trim().toLowerCase(),N()});window.addEventListener("resize",()=>{a.width(window.innerWidth).height(window.innerHeight)});a.width(window.innerWidth).height(window.innerHeight);Se();function be(){if(document.getElementById("ui"))return;const e=document.createElement("div");for(e.innerHTML=`
    <div id="ui" class="panel core-taxonomy-panel">
      <div class="brand">Core Taxonomy Graph</div>
      <div class="subtitle">vovaipetrova-core</div>
      <div class="section">
        <div id="dataStatus" class="status">Loading...</div>
        <button id="resetCamera" class="btn">Reset Camera</button>
      </div>
      <div class="section">
        <div class="section-title">Search</div>
        <input id="searchInput" class="input" type="search" placeholder="label or id" />
      </div>
      <div class="section">
        <div class="section-title">Node Types</div>
        <div id="typeFilters" class="chip-list"></div>
      </div>
      <div id="error" class="error hidden"></div>
    </div>
  `;e.firstElementChild;)document.body.appendChild(e.firstElementChild)}
